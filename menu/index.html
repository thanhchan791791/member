<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Nhà Hàng Cao Cấp - Đặt Món Nhanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /* Định nghĩa màu chủ đạo mới: Light Wood & Deep Espresso */
        :root {
            --color-primary-wood: #6B4423;      /* Nâu Espresso Đậm (CTA/Primary - Nút bấm) */
            --color-secondary-gold: #A38E6D;    /* Đồng Mờ (Highlight/Price) */
            --color-background-light: #FAF5EF;   /* Nền tổng thể: Kem Gỗ Sồi Nhạt */
            --color-card-bg-light: #FFFFFF;     /* Nền card món ăn: Trắng tinh */
            --color-text-dark: #2C1D15;         /* Màu chữ chính: Nâu Đen Đậm */
            --color-text-muted: #574B40;        /* Màu chữ phụ */
            --color-shadow-wood-light: rgba(107, 68, 35, 0.15); /* Shadow Gỗ Nhẹ */
            --color-shadow-wood-heavy: rgba(107, 68, 35, 0.3);  /* Shadow Gỗ Nặng */
            --color-placeholder: #F0E8E1;       /* Màu trung tính cho placeholder ảnh */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background-light); 
            color: var(--color-text-dark); 
            -webkit-tap-highlight-color: transparent;
        }
        
        .display-font {
            font-family: 'Playfair Display', serif;
        }

        .stepper-btn {
            transition: transform 0.1s ease-out, background-color 0.1s;
        }
        .stepper-btn:active {
            transform: scale(0.85); 
        }
        .cta-button {
             transition: all 0.15s ease-out;
             box-shadow: 0 4px 10px var(--color-shadow-wood-heavy);
        }
        .cta-button:active {
             transform: scale(0.98);
             box-shadow: 0 2px 5px var(--color-shadow-wood-heavy);
        }

        .ios-card {
            background-color: var(--color-card-bg-light); 
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); 
            box-shadow: 0 4px 12px var(--color-shadow-wood-light);
            border-radius: 24px; 
            will-change: transform, box-shadow;
            border: 1px solid #EBE4D9; 
        }
        .ios-card:hover, .ios-card.active-tap {
            transform: translateY(-4px); 
            box-shadow: 0 8px 18px var(--color-shadow-wood-heavy);
        }
        
        /* --- Style cho Featured Card (Đã bỏ, giữ lại phòng trường hợp cần thiết) --- */
        .featured-card {
             background-color: var(--color-card-bg-light); 
             box-shadow: 0 6px 16px var(--color-shadow-wood-heavy);
             border: 2px solid var(--color-secondary-gold);
             transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .featured-card:hover {
            transform: scale(1.02);
        }


        .drawer-bg, .header-bg {
            background-color: var(--color-background-light);
        }
        .cart-drawer {
            transition: transform 0.4s cubic-bezier(0.3, 0.7, 0.4, 1.5);
            transform: translateY(100%);
        }
        .cart-drawer.open {
            transform: translateY(0);
        }
        
        /* --- Cập nhật Style cho Tab Item (Dành cho tabs ngang Món Ăn/Thức Uống) --- */
        .tab-item {
            position: relative;
            transition: color 0.3s ease-in-out, transform 0.3s ease-in-out;
            font-weight: 700 !important; /* Luôn đậm */
        }
        .tab-item.active {
             transform: scale(1.05); /* Hiệu ứng nổi bật khi active */
        }
        .tab-item::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px; /* Tăng độ dày underline */
            background-color: transparent;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scaleX(0);
            border-radius: 2px;
        }
        .tab-item.active::after {
            background-color: var(--color-primary-wood); /* Đổi màu underline sang Primary Wood */
            transform: scaleX(1);
        }
        
        /* --- Style cho Vertical Tab Item (Danh mục con dọc) --- */
        .vertical-tab-item {
            position: relative;
            padding: 10px 0;
            cursor: pointer;
            text-align: center;
            font-weight: 700 !important;
            transition: color 0.3s ease-in-out, background-color 0.3s ease-in-out;
            border-radius: 8px; /* Bo góc nhẹ */
            user-select: none;
        }
        .vertical-tab-item.active {
             background-color: var(--color-placeholder); /* Nền nhẹ khi active */
             color: var(--color-primary-wood) !important;
        }
        .vertical-tab-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px; /* Độ dày border trái */
            height: 100%;
            background-color: transparent;
            transition: background-color 0.3s ease-in-out;
            border-radius: 2px;
        }
        .vertical-tab-item.active::before {
            background-color: var(--color-primary-wood); /* Đổi màu border sang Primary Wood */
        }
        
        #floating-cart-bubble {
            box-shadow: 0 6px 15px var(--color-shadow-wood-heavy); 
            border: 2px solid var(--color-card-bg-light); 
        }
        
        @keyframes subtle-shake {
            0%, 100% { transform: scale(1) translate(0, 0); }
            20%, 60% { transform: scale(1.05) translate(-1px, 1px); }
            40%, 80% { transform: scale(1.05) translate(1px, -1px); }
        }
        .bubble-shake {
            animation: subtle-shake 0.4s ease-in-out;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- CSS cho SVG Checkmark Animation --- */
        .checkmark-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checkmark {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: var(--color-primary-wood); 
            stroke-miterlimit: 10;
            box-shadow: inset 0 0 0 var(--color-primary-wood); 
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 4;
            stroke-miterlimit: 10;
            stroke: var(--color-primary-wood);
            fill: none;
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; 
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke: var(--color-primary-wood);
            fill: none;
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; 
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }
        @keyframes fill {
            100% { box-shadow: inset 0 0 0 30px var(--color-background-light); } 
        }

        /* --- CSS cho Loading Spinner Ấn Tượng --- */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        
        .loading-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 60; 
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .loading-message.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .loading-box {
            background-color: var(--color-card-bg-light);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            color: var(--color-text-dark);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .loading-message.show .loading-box {
            transform: scale(1);
        }
        .loading-title {
            color: var(--color-primary-wood);
            font-family: 'Playfair Display', serif;
        }

        /* ------------------------------------- */
        /* --- HIỆU ỨNG CHUYỂN TAB MỚI (iOS) --- */
        /* ------------------------------------- */
        #menu-list-container { /* Đã đổi từ #menu-list */
            position: relative; 
            transition: opacity 0.35s ease-in-out, transform 0.35s ease-in-out; 
        }
        
        /* Trạng thái chuẩn bị chuyển (ẩn) */
        #menu-list-container.fade-out-right {
             opacity: 0;
             transform: translateX(10px); /* Bắt đầu trượt từ phải */
        }
        #menu-list-container.fade-out-left {
             opacity: 0;
             transform: translateX(-10px); /* Bắt đầu trượt từ trái */
        }
        
        /* Trạng thái sau khi chuyển (hiện) */
        #menu-list-container.fade-in {
             opacity: 1;
             transform: translateX(0);
        }
        /* ------------------------------------- */
        
    </style>
</head>
<body>
    <div id="app" class="max-w-xl mx-auto min-h-screen relative p-4 pb-32">
        
        <header class="flex justify-between items-center py-4 sticky top-0 z-30 header-bg">
            <div class="flex items-center space-x-2">
<img 
  src="logobanme.png" 
  alt="Logo Nhà Hàng" 
  class="h-20 w-auto rounded-xl shadow-md"
/>


            </div>
            
            <div class="flex-1 text-center absolute left-0 right-0 top-1/2 transform -translate-y-1/2 pointer-events-none">
                <span class="text-4xl font-extrabold tracking-wider display-font" style="color: var(--color-text-dark);">The </span>
                <span class="text-4xl font-extrabold display-font italic" style="color: var(--color-secondary-gold);">Menu</span>
            </div>
            
            <div class="w-[64px] h-16"></div> 
        </header>
        
        <div class="sticky top-[100px] z-20 pb-4 header-bg">
            <div id="main-category-tabs" class="flex overflow-x-scroll no-scrollbar space-x-6 pb-2 border-b border-gray-200 mb-4">
                 </div>
            </div>

        <div class="flex">
             <div id="sub-category-list" 
                 class="w-1/4 max-w-[120px] pr-2 flex flex-col space-y-2 overflow-y-auto no-scrollbar sticky top-[160px] max-h-[calc(100vh-180px)]">
                 </div>
             <div id="menu-list-container" class="flex-1 pl-2">
                 <div id="menu-list" class="grid grid-cols-2 gap-4">
                    </div>
            </div>
        </div>

        <button id="floating-cart-bubble" 
                class="fixed bottom-6 right-6 z-50 p-4 rounded-full text-white shadow-xl flex items-center space-x-2 transition-all duration-300 scale-0 origin-bottom-right" 
                style="background-color: var(--color-primary-wood);"
                onclick="toggleCart(true)">
            <svg id="cart-svg-bubble" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span id="bubble-item-count" class="font-bold text-sm">0</span>
        </button>

        <div id="fly-clone" class="fixed rounded-full z-50 transition-all duration-500 ease-out pointer-events-none opacity-0" 
             style="background-color: var(--color-primary-wood); width: 0; height: 0;"></div>

        <div id="cart-drawer" class="cart-drawer fixed inset-x-0 bottom-0 z-40 rounded-t-3xl shadow-2xl max-h-[85vh] flex flex-col"
             style="background-color: var(--color-background-light);">
            <div class="p-4 border-b border-gray-100 relative">
                <button onclick="toggleCart(false)" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--color-text-dark);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-xl font-bold text-center" style="color: var(--color-text-dark);">Giỏ Hàng Của Bạn</h2>
            </div>
            
            <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-4">
                <p id="empty-cart-message" class="text-center mt-10" style="color: var(--color-text-muted);">Giỏ hàng trống.</p>
                </div>

            <div id="cart-summary" class="p-4 border-t-2 border-gray-200 shadow-inner" style="background-color: var(--color-card-bg-light);">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold" style="color: var(--color-text-dark);">Tổng cộng:</span>
                    <span id="cart-total" class="text-2xl font-extrabold" style="color: var(--color-primary-wood);">0đ</span>
                </div>
                <button id="checkout-button" class="cta-button w-full text-white font-bold py-3 px-4 rounded-full text-lg shadow-lg opacity-50 cursor-not-allowed" 
                        style="background-color: var(--color-primary-wood);"
                        disabled
                        onclick="handleCheckout()">
                    Đặt món ngay
                </button>
            </div>
        </div>
        
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="p-8 rounded-xl shadow-2xl w-11/12 max-w-xs transform scale-90 transition-transform duration-300" 
                 style="background-color: var(--color-card-bg-light);">
                <div id="lottie-success-container" class="w-24 h-24 mx-auto mb-4"></div>
                <h3 class="text-xl font-extrabold mb-2 text-center" style="color: var(--color-primary-wood);">Đặt Món Thành Công!</h3>
                <p class="text-center text-sm" style="color: var(--color-text-muted);">Đơn hàng của bạn đã được gửi.</p>
                <button onclick="closeSuccessPopup()" class="cta-button mt-6 w-full py-3 rounded-full text-white font-semibold" 
                        style="background-color: var(--color-primary-wood);">
                    Tiếp tục gọi món
                </button>
            </div>
        </div>

        <div id="error-popup" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="p-8 rounded-xl shadow-2xl w-11/12 max-w-lg transform scale-90 transition-transform duration-300" 
                 style="background-color: var(--color-card-bg-light); border: 2px solid red;">
                <h3 class="text-xl font-extrabold mb-2 text-center text-red-600">Lỗi Đặt Món!</h3>
                <div class="max-h-[60vh] overflow-y-auto p-3 rounded-lg border-2 border-gray-300 mt-3" style="background-color: #f8f8f8;">
                    <pre id="error-message" class="whitespace-pre-wrap text-sm text-red-700"></pre>
                </div>
                <button onclick="closeErrorPopup()" class="cta-button mt-6 w-full py-3 rounded-full text-white font-semibold" 
                        style="background-color: red;">
                    Đóng
                </button>
            </div>
        </div>

        <div id="item-config-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div id="item-config-box" class="p-6 rounded-xl shadow-2xl w-11/12 max-w-md transform scale-90 transition-transform duration-300" 
                 style="background-color: var(--color-card-bg-light);">
                
                <button onclick="closeItemConfigModal()" class="absolute right-4 top-4 p-2 rounded-full hover:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--color-text-dark);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>

                <h3 class="text-2xl font-extrabold mb-4 text-center display-font" style="color: var(--color-primary-wood);" id="config-item-name">Chọn món trong Mẹt</h3>
                
                <div class="flex items-center space-x-4 mb-4 p-3 rounded-lg" style="background-color: var(--color-placeholder);">
                     <img id="config-item-image" src="img/pepsi.png" class="w-16 h-16 object-cover rounded-lg">
                     <div>
                         <p class="font-bold text-lg" style="color: var(--color-text-dark);" id="config-item-display-name">Tên Món</p>
                         <p class="font-semibold text-xl" style="color: var(--color-secondary-gold);" id="config-item-price">Giá</p>
                     </div>
                </div>

                <div class="max-h-[50vh] overflow-y-auto pr-2 mb-4">
                    <div id="config-rules" class="p-3 mb-4 rounded-lg text-sm font-medium border" style="background-color: #fcf6f0; border-color: var(--color-primary-wood);">
                        </div>
                    
                    <h4 class="font-bold text-lg mt-4 mb-2" style="color: var(--color-primary-wood);">Chọn Món Thịt (<span id="meat-limit-text">0</span>)</h4>
                    <div id="meat-options-container" class="space-y-2">
                        </div>

                    <h4 class="font-bold text-lg mt-4 mb-2" style="color: var(--color-primary-wood);">Chọn Món Rau (<span id="veg-limit-text">0</span>)</h4>
                    <div id="veg-options-container" class="space-y-2">
                        </div>
                </div>
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <label class="font-semibold" style="color: var(--color-text-dark);">Số lượng:</label>
                    <div class="flex items-center space-x-2 border border-gray-200 rounded-full p-1 shadow-sm" style="background-color: var(--color-card-bg-light);">
                        <button class="stepper-btn w-8 h-8 flex items-center justify-center rounded-full bg-white text-gray-500" 
                                onclick="updateConfigQuantity(-1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                        </button>
                        <span id="config-quantity" class="font-bold text-lg w-4 text-center" style="color: var(--color-text-dark);">1</span>
                        <button class="stepper-btn w-8 h-8 flex items-center justify-center rounded-full text-white" 
                                style="background-color: var(--color-primary-wood);"
                                onclick="updateConfigQuantity(1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>

                <button id="config-add-to-cart-btn" class="cta-button mt-4 w-full py-3 rounded-full text-white font-semibold text-lg" 
                        style="background-color: var(--color-primary-wood);"
                        data-item-id="" 
                        onclick="confirmConfigAndAddToCart()">
                    Thêm vào Giỏ Hàng
                </button>
            </div>
        </div>
        <div id="loading-overlay" class="loading-message">
            <div class="loading-box">
                 <div class="loading-spinner mx-auto" style="border-top-color: var(--color-primary-wood); border-width: 5px; width: 40px; height: 40px;"></div>
                 <h3 class="text-xl loading-title font-extrabold mt-4">Đang Gửi Đơn Hàng...</h3>
                 <p class="text-sm mt-1" style="color: var(--color-text-muted);">Vui lòng đợi trong giây lát.</p>
            </div>
        </div>


    </div>
    
    <script type="module">
        // Import Firebase SDK (Dù không dùng set, vẫn cần onValue để tải menu)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // --- Cấu hình và Khởi tạo Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat-test.appspot.com",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

      const TELEGRAM_BOT_TOKEN = "7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI";
        const TELEGRAM_CHAT_ID = "-4954039835";
        const API_ENDPOINT = 'https://ordermenu-cp5t2kbgx-thanhduy.vercel.app/api/server.js';
        
        // --- Cấu hình API In ấn ---
        const PRINT_API_ENDPOINT = "http://192.168.156.210:5000/print";


        // --- Biến State Cần Thiết ---
        let menuData = {};    // Dữ liệu menu gốc: { food: { id: item, ...}, drink: {...} }
        let menuGroupsData = {}; // Dữ liệu menu nhóm: { food: { groupKey: { id: item, ... }, ... }, drink: {...} }
        let flatMenuData = {}; // Dữ liệu phẳng: { id: {item, categoryKey, groupKey, ...} }
        let cartItems = {};    
        
        // Cập nhật cấu trúc: categories là danh mục lớn (food, drink)
        // 🔑 SỬA ĐỔI: Thêm mảng keyGroups để kiểm soát thứ tự hiển thị của các nhóm con
        const categories = {
            food: { label: 'Món Ăn', index: 0, groupData: {}, keyGroups: [] }, 
            drink: { label: 'Thức Uống', index: 1, groupData: {}, keyGroups: [] }   
        };
        
        // activeCategoryKey: Key danh mục lớn đang hoạt động (food/drink)
        let activeCategoryKey = 'food'; 
        // activeGroupKey: Key nhóm con đang hoạt động (monLau/nuocEp/...)
        let activeGroupKey = ''; 
        
        let previousGroupKey = ''; // Biến lưu nhóm con trước đó

        // 🚨 THÊM BIẾN VÀ HÀM CHO POPUP TÙY CHỈNH (MÓN MẸT) 🚨
        
        // State for the modal
        let activeConfigItemId = null;
        let activeConfigQuantity = 1;
        let meatLimit = 0; // Giới hạn chọn món thịt
        let vegLimit = 0;  // Giới hạn chọn món rau

        // Constants for customization (theo yêu cầu mới)
        const MEAT_OPTIONS = [
            "Heo nướng",
            "Cá khô xóc muối",
            "Gà xào xả ớt",
            "Cá nướng giã muối ớt",
            "Măng xào thịt ba chỉ"
        ];

        const VEGETABLE_OPTIONS = [
            "Đu đủ đâm",
            "Rau bí xào tỏi",
            "Cà dã",
            "Lá mì xào"
        ];

        // Function to check item name and set limits
        const getMekItemLimits = (itemName) => {
            if (!itemName) return null;
            // Chuyển sang chữ thường, loại bỏ dấu và khoảng trắng để chuẩn hóa kiểm tra
            const normalizedName = itemName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, ''); 
            
            if (normalizedName.includes('met4mon')) {
                // Mẹt 4 món: 1 Thịt, 2 Rau
                return { meat: 1, veg: 2, type: '4mon' };
            }
            if (normalizedName.includes('met5mon')) {
                // Mẹt 5 món: 2 Thịt, 2 Rau
                return { meat: 2, veg: 2, type: '5mon' };
            }
            return null;
        };
        
        // Helper to generate checkboxes
        const generateCheckboxOptions = (options, type, limit) => {
            return options.map((name, index) => `
                <label class="flex items-center p-2 rounded-lg transition duration-150 cursor-pointer hover:shadow-md" style="background-color: var(--color-placeholder);">
                    <input type="checkbox" name="${type}" value="${name}" 
                           data-type="${type}" class="config-checkbox-${type} w-5 h-5 text-lg rounded"
                           style="color: var(--color-primary-wood); border-color: var(--color-text-dark); accent-color: var(--color-primary-wood);">
                    <span class="ml-3 font-medium text-base" style="color: var(--color-text-dark);">${name}</span>
                </label>
            `).join('');
        };
        
        // Validation logic
        const validateSelection = (type, limit) => {
            const selector = `.config-checkbox-${type}`;
            const checkboxes = document.querySelectorAll(selector);
            const selected = document.querySelectorAll(`${selector}:checked`).length;
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked && selected >= limit) {
                    checkbox.disabled = true;
                    checkbox.parentNode.classList.add('opacity-50');
                    checkbox.parentNode.classList.remove('cursor-pointer');
                } else {
                    checkbox.disabled = false;
                    checkbox.parentNode.classList.remove('opacity-50');
                    checkbox.parentNode.classList.add('cursor-pointer');
                }
            });
        };

        window.showItemConfigModal = (id, item) => {
            activeConfigItemId = id;
            activeConfigQuantity = 1; // Luôn reset số lượng về 1 khi mở
            
            const limits = getMekItemLimits(item.name);
            if (!limits) {
                // Không phải món mẹt, không nên gọi hàm này.
                return; 
            }
            
            meatLimit = limits.meat;
            vegLimit = limits.veg;

            const modal = document.getElementById('item-config-modal');
            if (!modal) return;
            
            // Update content
            document.getElementById('config-item-name').textContent = item.name;
            document.getElementById('config-item-display-name').textContent = item.name;
            document.getElementById('config-item-price').textContent = formatCurrency(item.price);
            document.getElementById('config-quantity').textContent = activeConfigQuantity;
            document.getElementById('config-add-to-cart-btn').setAttribute('data-item-id', id);

            const imageUrl = item.img && item.img.startsWith('http') 
                             ? item.img 
                             : `https://placehold.co/100x100/F0E8E1/6B4423?text=${item.name.toUpperCase().replace(/\s/g, '+') || 'MEC+IMAGE'}`;
            document.getElementById('config-item-image').src = imageUrl;
            document.getElementById('config-item-image').onerror=null;
            document.getElementById('config-item-image').src = imageUrl;

            // Render Rules
            const rulesEl = document.getElementById('config-rules');
            rulesEl.innerHTML = `
                <p>Món *<span class="font-bold">${item.name}</span>* cho phép bạn chọn tối đa:</p>
                <ul class="list-disc list-inside mt-1 ml-2">
                    <li><span class="font-bold text-red-600">${limits.meat}</span> Món Thịt.</li>
                    <li><span class="font-bold text-red-600">${limits.veg}</span> Món Rau.</li>
                </ul>
            `;
            
            // Render Meat Options
            const meatContainer = document.getElementById('meat-options-container');
            meatContainer.innerHTML = generateCheckboxOptions(MEAT_OPTIONS, 'meat', meatLimit);
            document.getElementById('meat-limit-text').textContent = `Tối đa ${limits.meat} món`;

            // Render Vegetable Options
            const vegContainer = document.getElementById('veg-options-container');
            vegContainer.innerHTML = generateCheckboxOptions(VEGETABLE_OPTIONS, 'veg', vegLimit);
            document.getElementById('veg-limit-text').textContent = `Tối đa ${limits.veg} món`;

            // Attach event listeners for validation (Cần gọi lại mỗi lần mở modal)
            document.querySelectorAll('.config-checkbox-meat').forEach(checkbox => {
                checkbox.onchange = () => validateSelection('meat', meatLimit);
            });
            document.querySelectorAll('.config-checkbox-veg').forEach(checkbox => {
                checkbox.onchange = () => validateSelection('veg', vegLimit);
            });


            // Show modal
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('item-config-box')?.classList.remove('scale-90');
        };

        window.closeItemConfigModal = () => {
            const modal = document.getElementById('item-config-modal');
            if (!modal) return;

            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('item-config-box')?.classList.add('scale-90');
            activeConfigItemId = null;
            activeConfigQuantity = 1;
            meatLimit = 0;
            vegLimit = 0;
        };

        window.updateConfigQuantity = (change) => {
            const newQuantity = activeConfigQuantity + change;
            if (newQuantity >= 1) {
                activeConfigQuantity = newQuantity;
                document.getElementById('config-quantity').textContent = activeConfigQuantity;
            }
        };

        window.confirmConfigAndAddToCart = () => {
            const id = activeConfigItemId;
            const quantity = activeConfigQuantity;
            
            if (!id || quantity < 1) return;
            
            // Gather selected options
            const selectedMeat = Array.from(document.querySelectorAll('.config-checkbox-meat:checked')).map(cb => cb.value);
            const selectedVeg = Array.from(document.querySelectorAll('.config-checkbox-veg:checked')).map(cb => cb.value);

            // Final Validation check before adding
            if (selectedMeat.length > meatLimit || selectedVeg.length > vegLimit) {
                alert(`Lỗi: Vui lòng không chọn quá giới hạn cho phép. Thịt: ${meatLimit}, Rau: ${vegLimit}.`);
                return;
            }
            
            if (selectedMeat.length === 0 && selectedVeg.length === 0) {
                alert("Vui lòng chọn ít nhất một món (thịt hoặc rau) cho Mẹt.");
                return;
            }

            closeItemConfigModal();

            const item = flatMenuData[id];
            
            // Create a unique identifier for this customization instance (để tránh bị gộp món)
            const customKey = `${id}-${Date.now()}`;
            
            // Create a custom item object including the selections
            const customItem = {
                item: item, 
                quantity: quantity,
                customizations: {
                    meat: selectedMeat,
                    veg: selectedVeg
                }
            };
            
            // Add to cart using the custom key
            cartItems[customKey] = customItem;


            // Kích hoạt hiệu ứng lắc và render giỏ hàng
            const floatingBubble = document.getElementById('floating-cart-bubble');
            if (floatingBubble) {
                floatingBubble.classList.add('bubble-shake');
                setTimeout(() => floatingBubble.classList.remove('bubble-shake'), 500);
            }
            renderCart(); // Gọi render cart ngay lập tức
        };

        // 🚨 KẾT THÚC THÊM BIẾN VÀ HÀM CHO POPUP TÙY CHỈNH 🚨


        // --- Helpers ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('₫', 'đ');
        };

        const getCartTotal = (items = cartItems) => {
            return Object.values(items).reduce((sum, item) => sum + item.item.price * item.quantity, 0);
        };
        
        const generateOrderId = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '-';
            for (let i = 0; i < 20; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        };
        
        const generateTableId = () => {
             return '-OaGqKwtZ3S4gzRY14ai';
        };

        // 🚨 THÊM HÀM LẤY TÊN BÀN TỪ URL 🚨
        const getTableNameFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            let tableName = urlParams.get('table'); 
            
            if (tableName && tableName.trim() !== '') {
                // Chuyển sang chữ hoa và cắt khoảng trắng để chuẩn hóa
                return tableName.toUpperCase().trim();
            }
            
            // Tên bàn mặc định nếu không có tham số 'table'
            return 'B1'; 
        };
        // 🚨 KẾT THÚC THÊM HÀM LẤY TÊN BÀN 🚨
        
        // Lấy thời gian hiện tại theo định dạng YYYY-MM-DD HH:MM:SS
        const getCurrentDateTime = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        };

        const sampleData = {
            menu: {
                drink: {
                  "-O_rTJ0wxPOh3vwzVBkf": { name: "pepsi", price: 30000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Pepsi" },
                  "-Oa403XF8CuYwOfIK2lh": { name: "Trà đào cam sả đặc biệt", price: 85000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Tra+Dao" }
                },
                food: {
                  "-O_rTEe0SYGEcdvjBkNk": { name: "Mẹt 6 người", price: 500000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Mec+6" },
                  "-Lw-R-M-aWb-0lI-7H2f": { name: "Thăn nội bò nướng than", price: 1250000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Bo+Nuong" },
                  "-Oa403XF8CuYwOfIK2lh-2": { name: "Lẩu Tứ Xuyên", price: 450000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Lau+Tu+Xuyen" }
                }
            },
            menuGroups: {
                drink: {
                    coCon: { "-O_rTJ0wxPOh3vwzVBkf": { name: "pepsi", price: 30000 } },
                    nuocEp: { "-Oa403XF8CuYwOfIK2lh": { name: "Trà đào", price: 85000 } }
                },
                food: {
                    monLau: { "-Oa403XF8CuYwOfIK2lh-2": { name: "Lẩu Tứ Xuyên", price: 450000 } },
                    monNuong: { "-Lw-R-M-aWb-0lI-7H2f": { name: "Thăn nội bò nướng than", price: 1250000 } }
                }
            }
        };
        
        // 🔑 SỬA ĐỔI: Thêm GROUP_ORDER để định nghĩa thứ tự ưu tiên
        const GROUP_ORDER = {
            // Thứ tự Món Ăn
            food: [
                "7mon",
                "4mon",
                "metTongHop",
                "monCanh",
                "monChinh",
                "monLau",
                "monRau",
            ],
            // Thứ tự Thức Uống
            drink: [
                "nuocEp",
                "coCon",
                "giaiKhat"
            ]
        };

        // Ánh xạ key group Firebase sang tên hiển thị (Có thể mở rộng)
        const GROUP_NAME_MAP = {
             "7mon": "7 Món Nên Trải Nghiệm",
            "4mon": "4 Món Phải Thử",
            "metTongHop": "Mẹt Món Tổng Hợp",
            "monCanh": "Món Canh",
            "monChinh": "Món Chính",
            "monLau": "Món Lẩu",
            "monRau": "Món Rau",
            "coCon": "Đồ Uống Có Cồn",
            "giaiKhat": "Giải Khát",
            "nuocEp": "Nước Ép & Khác"
        };

        async function initData() {
            const rootRef = ref(db, "/");
            onValue(rootRef, (snapshot) => {
                let data = snapshot.val();
                
                if (!data || !data.menuGroups || (Object.keys(data.menuGroups).length === 0)) {
                    console.log("⚡ Chưa có dữ liệu nhóm menu → Ghi dữ liệu mẫu");
                    data = sampleData;
                    set(rootRef, sampleData)
                        .then(() => console.log("Đã ghi dữ liệu mẫu."))
                        .catch(err => console.error("Lỗi ghi dữ liệu mẫu:", err));
                }
                
                loadAndRenderMenu(data);
            }, {
                onlyOnce: false 
            });
        }
        
        function loadAndRenderMenu(data) {
            menuData = data.menu || {};
            menuGroupsData = data.menuGroups || {};

            flatMenuData = {};
            let firstGroupKey = '';
            
            // Xử lý dữ liệu và làm phẳng
            Object.keys(menuGroupsData).forEach(catKey => { // catKey: food/drink
                const catGroups = menuGroupsData[catKey];
                
                if (!categories[catKey]) {
                     console.warn(`Lỗi: Không tìm thấy định nghĩa cho category key: ${catKey}`);
                     return; 
                }
                
                categories[catKey].groupData = {}; 
                categories[catKey].keyGroups = []; // Reset mảng keyGroups
                
                // 🔑 SỬA ĐỔI: Lặp qua GROUP_ORDER để đảm bảo thứ tự
                const orderedKeys = GROUP_ORDER[catKey] || [];
                const allGroupKeys = new Set([...orderedKeys, ...Object.keys(catGroups)]);
                
                allGroupKeys.forEach(groupKey => { // groupKey: 4mon/monLau/...
                    const items = catGroups[groupKey];

                    if (!items) return; // Bỏ qua nếu groupKey có trong ORDER nhưng không có data

                    // Thêm group vào category object
                    categories[catKey].groupData[groupKey] = {
                        label: GROUP_NAME_MAP[groupKey] || groupKey.toUpperCase(),
                        items: items
                    };
                    
                    // Thêm key vào danh sách đã sắp xếp
                    categories[catKey].keyGroups.push(groupKey);

                    // Gán groupKey cho flatMenuData 
                    Object.keys(items).forEach(id => {
                        const itemDetails = menuData[catKey]?.[id] || items[id]; 
                        
                        flatMenuData[id] = { 
                            id: id, 
                            ...itemDetails, 
                            categoryKey: catKey, 
                            groupKey: groupKey,
                            type: catKey === 'food' ? 'food' : 'drink' 
                        }; 

                        if (!firstGroupKey) firstGroupKey = groupKey;
                    });
                });
            });
            
            // 2. Thiết lập active Category và Group ban đầu
            if (!categories[activeCategoryKey] || categories[activeCategoryKey].keyGroups.length === 0) {
                 activeCategoryKey = Object.keys(categories).find(key => categories[key].keyGroups.length > 0) || 'food';
            }
            
            const currentGroups = categories[activeCategoryKey]?.groupData || {};
            if (!activeGroupKey || !currentGroups[activeGroupKey]) {
                 activeGroupKey = categories[activeCategoryKey].keyGroups[0] || ''; // Lấy groupKey đầu tiên theo thứ tự mới
            }
            
            renderMainCategoryTabs(); 
            renderSubCategoryTabs();  
            renderMenu(false); 
            renderCart(); 
        }

        // --- Render Functions ---

        // Hàm render tabs Danh mục chính (Foods/Drinks)
        window.renderMainCategoryTabs = () => {
            const tabsContainer = document.getElementById('main-category-tabs');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = '';
            
            // Lặp qua keys của categories (food, drink)
            Object.keys(categories).forEach(key => { 
                // Chỉ hiển thị tab nếu có dữ liệu nhóm
                if (categories[key].keyGroups.length > 0) {
                    const isActive = key === activeCategoryKey;
                    const tabHtml = `
                        <button data-main-category="${key}" onclick="setActiveMainCategory('${key}')" 
                                class="tab-item px-1 py-2 text-xl font-extrabold whitespace-nowrap ${isActive ? 'active' : ''}"
                                style="transition: all 0.3s; color: ${isActive ? 'var(--color-primary-wood)' : 'var(--color-text-muted)'};">
                            ${categories[key].label}
                        </button>
                    `;
                    tabsContainer.innerHTML += tabHtml;
                }
            });
            
            const activeTab = tabsContainer.querySelector(`.tab-item[data-main-category="${activeCategoryKey}"]`);
            if (activeTab) {
                 activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        };

        // Hàm render tabs Nhóm con (CẬP NHẬT CHO HIỂN THỊ DỌC)
        window.renderSubCategoryTabs = () => {
            // Target container mới: #sub-category-list
            const tabsContainer = document.getElementById('sub-category-list');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = '';
            
            const currentCat = categories[activeCategoryKey];
            const currentGroups = currentCat?.groupData || {};
            
            // Lặp qua mảng keyGroups đã được sắp xếp
            currentCat?.keyGroups.forEach(key => {
                const group = currentGroups[key];
                if (!group) return; 

                const isActive = key === activeGroupKey;
                
                // SỬA: Dùng class `vertical-tab-item` và cấu trúc button mới
                const tabHtml = `
                    <button data-sub-category="${key}" onclick="setActiveGroup('${key}')" 
                            class="vertical-tab-item text-sm font-semibold whitespace-normal leading-tight ${isActive ? 'active' : ''}"
                            style="color: ${isActive ? 'var(--color-primary-wood)' : 'var(--color-text-dark)'};">
                        ${group.label}
                    </button>
                `;
                tabsContainer.innerHTML += tabHtml;
            });
            
            // Tự động cuộn đến nhóm đang active
            const activeTab = tabsContainer.querySelector(`.vertical-tab-item[data-sub-category="${activeGroupKey}"]`);
            if (activeTab) {
                 activeTab.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        // *Hàm chuyển đổi Danh mục chính*
        window.setActiveMainCategory = (key) => {
            if (key === activeCategoryKey) return;

            // Lấy groupKey đầu tiên của danh mục mới theo thứ tự đã định nghĩa
            const newGroupsKeys = categories[key]?.keyGroups || [];
            const newFirstGroupKey = newGroupsKeys[0] || '';
            
            if (newFirstGroupKey) {
                activeCategoryKey = key;
                previousGroupKey = activeGroupKey; // Lưu groupKey cũ
                activeGroupKey = newFirstGroupKey; // Thiết lập groupKey mới
                
                renderMainCategoryTabs();
                renderSubCategoryTabs();
                renderMenu(true); // Kích hoạt animation
            }
        };


        // *Cập nhật hàm setActiveGroup để lưu trữ nhóm cũ và gọi renderMenu có animation*
        window.setActiveGroup = (key) => {
            if (key === activeGroupKey) return;

            previousGroupKey = activeGroupKey; 
            activeGroupKey = key;
            
            renderSubCategoryTabs();
            renderMenu(true); // Kích hoạt animation
        };

        // *Cập nhật hàm renderMenu để hỗ trợ animation*
        window.renderMenu = (animate = true) => {
            // Target container mới: #menu-list-container
            const menuListContainer = document.getElementById('menu-list-container');
            if (!menuListContainer) return;

            // 1. Nếu có animation, ẩn danh sách món hiện tại với hiệu ứng trượt
            if (animate) {
                 const currentGroupKeys = categories[activeCategoryKey].keyGroups;
                 const currentGroupIndex = currentGroupKeys.indexOf(activeGroupKey);
                 const prevGroupIndex = currentGroupKeys.indexOf(previousGroupKey);
                 
                 menuListContainer.classList.remove('fade-in');
                 
                 // Quyết định hướng trượt (Trái: danh mục mới có index nhỏ hơn; Phải: danh mục mới có index lớn hơn)
                 const directionClass = currentGroupIndex > prevGroupIndex ? 'fade-out-right' : 'fade-out-left';
                 
                 menuListContainer.classList.add(directionClass);
                 
                 // Đợi animation fade out kết thúc (0.35s) rồi render nội dung mới
                 setTimeout(() => {
                      updateMenuListContent();
                      
                      // 3. Hiển thị nội dung mới với hiệu ứng trượt vào
                      menuListContainer.classList.remove('fade-out-right', 'fade-out-left');
                      menuListContainer.classList.add('fade-in');

                 }, 350);
            } else {
                 // Không animation, render ngay lập tức
                 updateMenuListContent();
                 menuListContainer.classList.add('fade-in');
            }
        };

        const updateMenuListContent = () => {
             const menuList = document.getElementById('menu-list');
             if (!menuList) return;
             
             menuList.innerHTML = '';
             
             // Lấy danh sách ID món ăn/thức uống của nhóm đang hoạt động
             const groupItems = menuGroupsData[activeCategoryKey]?.[activeGroupKey] || {};
            
            if (Object.keys(groupItems).length === 0) {
                 menuList.innerHTML = `<p class="col-span-2 text-center py-10" style="color: var(--color-text-muted);">Hiện tại không có món nào trong nhóm này.</p>`;
                 return;
            }

            Object.keys(groupItems).forEach(id => {
                // Sử dụng flatMenuData để lấy thông tin chi tiết đầy đủ
                const item = flatMenuData[id]; 
                
                // Nếu item không tồn tại trong flatMenuData (dữ liệu lỗi/mất mát), bỏ qua
                if (!item) return; 

                const imageUrl = item.img && item.img.startsWith('http') 
                                 ? item.img 
                                 : `img/pepsi.png`;

                const cardHtml = `
                    <div id="item-${id}" class="ios-card overflow-hidden flex flex-col cursor-pointer" 
                         onclick="addItemToCart('${id}')" 
                         ontouchstart="this.classList.add('active-tap')" ontouchend="this.classList.remove('active-tap')" 
                         onmouseleave="this.classList.remove('active-tap')">
               
<div class="w-full h-40 overflow-hidden rounded-t-2xl flex items-center justify-center" 
     style="background-color: var(--color-placeholder);">
    <img src="${imageUrl}" 
         onerror="this.onerror=null;this.src='https://placehold.co/1000x800/F0E8E1/6B4423?text=${item.name.toUpperCase().replace(/\s/g, '+') || 'FOOD+IMAGE'}';" 
         class="w-full h-full object-contain transition duration-300 transform hover:scale-105" alt="${item.name}">
</div>
                        <div class="p-4 flex flex-col justify-between flex-1">
                            <h3 class="text-base font-extrabold line-clamp-2 leading-snug" style="color: var(--color-text-dark);">${item.name}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xl font-bold" style="color: var(--color-secondary-gold);">${formatCurrency(item.price)}</span>
                                
                            </div>
                        </div>
                    </div>
                `;
                menuList.innerHTML += cardHtml;
            });
        }


      // window.renderCart
window.renderCart = () => {
    try {
        const cartList = document.getElementById('cart-items-list');
        const cartTotalElement = document.getElementById('cart-total');
        const emptyMessage = document.getElementById('empty-cart-message');
        const checkoutButton = document.getElementById('checkout-button');
        
        const floatingBubble = document.getElementById('floating-cart-bubble');
        const bubbleCount = document.getElementById('bubble-item-count');

        if (!cartList) return; 

        cartList.innerHTML = '';
        const total = getCartTotal();
        const itemCount = Object.values(cartItems).reduce((sum, item) => sum + item.quantity, 0);

        if (floatingBubble && bubbleCount) {
            bubbleCount.textContent = itemCount;
            floatingBubble.classList.toggle('scale-100', itemCount > 0);
            floatingBubble.classList.toggle('scale-0', itemCount === 0);
        }
        
        if (cartTotalElement) {
            cartTotalElement.textContent = formatCurrency(total);
        }

        if (emptyMessage) {
            emptyMessage.classList.toggle('hidden', itemCount > 0);
        }
        
        if (checkoutButton) {
            const isSending = checkoutButton.dataset.sending === 'true'; // Kiểm tra trạng thái đang gửi
            if (itemCount === 0 || isSending) {
                checkoutButton.disabled = true;
                checkoutButton.classList.add('opacity-50', 'cursor-not-allowed');
                if(!isSending) checkoutButton.innerHTML = 'Đặt món ngay'; // Đảm bảo không ghi đè nếu đang gửi
            } else {
                checkoutButton.disabled = false;
                checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed');
                checkoutButton.innerHTML = 'Đặt món ngay';
            }
        }

        Object.keys(cartItems).forEach(id => {
            const cartItem = cartItems[id];
            const item = cartItem.item;
            
            const imageUrl = item.img && item.img.startsWith('http') 
                                     ? item.img 
                                     : 'img/pepsi.png';
            
            // Lấy chi tiết tùy chỉnh (nếu có)
            const customizations = cartItem.customizations;
            let customizationDetails = '';
            if (customizations && (customizations.meat.length > 0 || customizations.veg.length > 0)) {
                const meatStr = customizations.meat.length > 0 ? `<span class="font-medium text-xs block mt-1" style="color: var(--color-text-muted);">Thịt: ${customizations.meat.join(', ')}</span>` : '';
                const vegStr = customizations.veg.length > 0 ? `<span class="font-medium text-xs block" style="color: var(--color-text-muted);">Rau: ${customizations.veg.join(', ')}</span>` : '';
                customizationDetails = `<div class="mt-1">${meatStr}${vegStr}</div>`;
            }
            
            const itemHtml = `
                <div class="flex items-center p-3 rounded-xl shadow-sm transition duration-300 border" style="background-color: var(--color-card-bg-light); border-color: #EBE4D9;">
                    <div class="w-16 h-16 rounded-lg mr-4 overflow-hidden flex items-center justify-center flex-shrink-0" 
                         style="background-color: var(--color-placeholder); border: 1px solid #EBE4D9;">
                        <img src="${imageUrl}" 
                             class="w-full h-full object-contain" // **ĐÃ SỬA TẠI ĐÂY**
                             onerror="this.onerror=null;this.src='img/pepsi.png';">
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold truncate text-sm" style="color: var(--color-text-dark);">${item.name}</p>
                        <p class="text-sm font-semibold" style="color: var(--color-secondary-gold);">${formatCurrency(item.price)} x ${cartItem.quantity}</p>
                        ${customizationDetails}
                    </div>
                    <div class="flex items-center space-x-2 border border-gray-200 rounded-full p-1 ml-4 shadow-sm" style="background-color: var(--color-card-bg-light);">
                        <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full bg-white text-gray-500" 
                                onclick="updateCartQuantity('${id}', -1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                        </button>
                        <span class="font-medium text-sm w-4 text-center" style="color: var(--color-text-dark);">${cartItem.quantity}</span>
                        <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full text-white" 
                                style="background-color: var(--color-primary-wood);"
                                onclick="updateCartQuantity('${id}', 1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
            `;
            cartList.innerHTML += itemHtml;
        });
    } catch (error) {
        console.error("Lỗi khi render Cart:", error);
    }
};

        // --- Cart Actions (ĐÃ CẬP NHẬT LOGIC KIỂM TRA MÓN MẸT) ---
        
        window.addItemToCart = (id) => {
            const item = flatMenuData[id];
            
            if (!item) return;

            // 🚨 LOGIC MỚI: KIỂM TRA MÓN MẸT ĐỂ HIỆN POPUP TÙY CHỈNH 🚨
            if (getMekItemLimits(item.name)) {
                showItemConfigModal(id, item); 
                return; // Dừng, không thêm vào giỏ hàng ngay lập tức
            }
            // 🚨 KẾT THÚC LOGIC MỚI 🚨

            // Logic cũ: Thêm thẳng vào giỏ hàng (số lượng 1)
            if (cartItems[id]) {
                cartItems[id].quantity += 1;
            } else {
                // Đối với các món không tùy chỉnh, item id = cart key
                cartItems[id] = { item: item, quantity: 1 };
            }

            const floatingBubble = document.getElementById('floating-cart-bubble');
            if (floatingBubble) {
                floatingBubble.classList.add('bubble-shake');
                setTimeout(() => floatingBubble.classList.remove('bubble-shake'), 500);
            }

            const itemCard = document.getElementById(`item-${id}`) || document.querySelector(`.featured-card[onclick*='${id}']`);
            if (itemCard) {
                const startRect = itemCard.getBoundingClientRect();
                const cartIcon = document.getElementById('floating-cart-bubble'); 
                const flyClone = document.getElementById('fly-clone');

                if (cartIcon && flyClone) {
                    const buttonSize = 40; 
                    
                    flyClone.style.top = `${startRect.top + startRect.height / 2 - buttonSize / 2}px`;
                    flyClone.style.left = `${startRect.left + startRect.width / 2 - buttonSize / 2}px`;
                    flyClone.style.width = `${buttonSize}px`;
                    flyClone.style.height = `${buttonSize}px`;
                    flyClone.style.opacity = 1;
                    flyClone.style.transform = 'scale(1)';

                    setTimeout(() => {
                        flyClone.style.top = `${cartIcon.getBoundingClientRect().top + cartIcon.getBoundingClientRect().height / 2 - 10}px`;
                        flyClone.style.left = `${cartIcon.getBoundingClientRect().left + cartIcon.getBoundingClientRect().width / 2 - 10}px`;
                        flyClone.style.width = '20px';
                        flyClone.style.height = '20px';
                        flyClone.style.opacity = 0.5;
                        flyClone.style.transform = 'scale(0.5)';
                    }, 50);

                    setTimeout(() => {
                        flyClone.style.opacity = 0;
                        flyClone.style.transform = 'scale(1)';
                        flyClone.style.width = '0px';
                        flyClone.style.height = '0px';
                        renderCart(); 
                    }, 750);
                } else {
                     renderCart();
                }
            } else {
                 renderCart();
            }
        };
        
        window.updateCartQuantity = (id, change) => {
            if (!cartItems[id]) return;

            const newQuantity = cartItems[id].quantity + change;
            
            if (newQuantity <= 0) {
                delete cartItems[id];
            } else {
                cartItems[id].quantity = newQuantity;
            }
            renderCart();
        };

        window.toggleCart = (open) => {
            const drawer = document.getElementById('cart-drawer');
            if (!drawer) return;

            if (open) {
                if (Object.keys(cartItems).length > 0) {
                    renderCart();
                    drawer.classList.add('open');
                } 
            } else {
                drawer.classList.remove('open');
            }
        };

        // --- Popup Functions (Sử dụng SVG/CSS Checkmark) ---
        
        // window.showSuccessPopup 
        window.showSuccessPopup = () => {
             const popup = document.getElementById('success-popup');
             const svgContainer = document.getElementById('lottie-success-container');
             if (!popup || !svgContainer) return;

             // THAY THẾ Lottie bằng SVG Checkmark và animation qua CSS
             svgContainer.innerHTML = `
                 <div class="checkmark-container">
                     <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                         <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                         <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                     </svg>
                 </div>
             `;

             popup.classList.remove('opacity-0', 'pointer-events-none');
             popup.querySelector('div')?.classList.remove('scale-90');
             
             // Tự động đóng sau 3 giây
             setTimeout(() => {
                closeSuccessPopup();
             }, 3000); 
        };

        // window.closeSuccessPopup 
        window.closeSuccessPopup = () => {
             const popup = document.getElementById('success-popup');
             const svgContainer = document.getElementById('lottie-success-container');
             if (!popup) return;
             popup.classList.add('opacity-0', 'pointer-events-none');
             popup.querySelector('div')?.classList.add('scale-90');
             
             // Dọn dẹp SVG checkmark
             if (svgContainer) svgContainer.innerHTML = '';

             // Reset giỏ hàng sau khi đặt món thành công
             cartItems = {};
             renderCart();
        };

        // window.showErrorPopup 
        window.showErrorPopup = (message) => {
            const popup = document.getElementById('error-popup');
            const errorMessage = document.getElementById('error-message');
            if (!popup || !errorMessage) return;

            errorMessage.textContent = message;
            popup.classList.remove('opacity-0', 'pointer-events-none');
            popup.querySelector('div')?.classList.add('scale-90');
        };

        // window.closeErrorPopup 
        window.closeErrorPopup = () => {
            const popup = document.getElementById('error-popup');
            if (!popup) return;
            popup.classList.add('opacity-0', 'pointer-events-none');
            popup.querySelector('div')?.classList.add('scale-90');
        };

        // --- Loading Overlay Functions MỚI ---
        const showLoading = () => {
             document.getElementById('loading-overlay')?.classList.add('show');
             document.getElementById('checkout-button')?.setAttribute('data-sending', 'true');
             document.getElementById('checkout-button').innerHTML = '<span class="loading-spinner"></span> Đang gửi...';
        };

        const hideLoading = () => {
             document.getElementById('loading-overlay')?.classList.remove('show');
             document.getElementById('checkout-button')?.removeAttribute('data-sending');
        };


        // --- Telegram & Checkout Logic (Cập nhật) ---

        async function sendTelegramNotification(message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const params = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (!response.ok) {
                    console.error("Lỗi Telegram API:", await response.text());
                } else {
                    console.log("Thông báo Telegram đã gửi thành công.");
                }
            } catch (err) {
                console.error("Lỗi kết nối Telegram:", err);
            }
        }
        
        // ** CẬP NHẬT HÀM handleCheckout **
window.handleCheckout = async () => {
    
    toggleCart(false);
    const currentCartItems = { ...cartItems }; // Tạo bản sao để sử dụng sau khi xóa cart
    if (Object.keys(currentCartItems).length === 0) {
        showErrorPopup("Giỏ hàng trống. Vui lòng chọn món trước khi đặt.");
        return;
    }
    
    showLoading(); // HIỂN THỊ LOADING

    // 🚨 DÒNG ĐÃ THAY ĐỔI: LẤY TÊN BÀN TỪ URL
    const tableName = getTableNameFromUrl(); 
    const totalAmount = getCartTotal(currentCartItems); 
    // const currentTime = getCurrentDateTime(); // Giữ nguyên, không dùng cho printData mới

    const itemsObject = {};
    let foodItems = [];
    let drinkItems = [];
    let printItemsForTelegram = []; // Danh sách món cho máy in cũ (chuỗi cho Telegram/Log)
    
    // ** DỮ LIỆU MỚI CHO API IN ẤN THEO YÊU CẦU **
    const printItemsForPrinter = []; 
    // **********************************************
    
    let hasFood = false;
    let hasDrink = false;

    // 1. Phân loại và định dạng món ăn/thức uống cho Telegram và In ấn
    Object.keys(currentCartItems).forEach(id => {
        const ci = currentCartItems[id];
        const itemType = ci.item.type;
        const customizations = ci.customizations;
        
        let customizationStr = '';
        let apiCustomization = {};

        if (customizations) {
            // Format for Telegram message
            const meatSel = customizations.meat.length > 0 ? ` [Thịt: ${customizations.meat.join(', ')}]` : '';
            const vegSel = customizations.veg.length > 0 ? ` [Rau: ${customizations.veg.join(', ')}]` : '';
            customizationStr = `${meatSel}${vegSel}`;
            
            // Format for API backend
            apiCustomization = customizations;
        }

        // Định dạng cho tin nhắn Telegram (dùng Markdown: *bold*)
        const itemString = `- ${ci.item.name} ${customizationStr} x *${ci.quantity}* (${formatCurrency(ci.item.price)})`;
        
        // Định dạng cho log/print cũ (vd: Phở bò x4)
        const printStringForLog = `${ci.item.name}${customizationStr} x${ci.quantity}`;
        printItemsForTelegram.push(printStringForLog); 

        // ** TẠO DỮ LIỆU CHO API IN ẤN MỚI **
        printItemsForPrinter.push({ 
            name: `${ci.item.name}${customizationStr}`, // Concatenate for printer name
            qty: ci.quantity 
        });
        // **********************************

        if (itemType === 'food') {
            hasFood = true;
            foodItems.push(itemString);
        } else if (itemType === 'drink') {
            hasDrink = true;
            drinkItems.push(itemString);
        }
        
        itemsObject[id] = { // Note: id here is the customKey now if it's a Mẹt
            itemName: ci.item.name,
            price: ci.item.price,
            quantity: ci.quantity,
            status: "pending", 
            type: itemType,
            customizations: apiCustomization // Added customization data
        };
    });
    
    // 2. Xây dựng nội dung tin nhắn Telegram
    let message = `*🧾 ĐƠN HÀNG MỚI (Bàn ${tableName})* \n`;
    message += `--------------------------------------\n`;

    if (hasFood) {
        message += `\n*🍽️ BẾP (MÓN ĂN)*\n`;
        message += foodItems.join('\n');
        message += `\n`;
    }

    if (hasDrink) {
        message += `\n*🍹 BAR (THỨC UỐNG)*\n`;
        message += drinkItems.join('\n');
        message += `\n`;
    }

    message += `\n*💵 TỔNG CỘNG: ${formatCurrency(totalAmount)}*`;
    
    // 3. Chuẩn bị Order cho API backend
    let orderType = 'misc'; 
    if (hasFood && hasDrink) {
        orderType = 'food_and_drink';
    } else if (hasFood) {
        orderType = 'food';
    } else if (hasDrink) {
        orderType = 'drink';
    }

    const finalOrder = {
        orderId: generateOrderId(), 
        tableId: generateTableId(), 
        tableName: tableName, 
        type: orderType, 
        items: itemsObject
    };
    
    console.log("JSON Đặt Món Sẽ Gửi (API Backend):", finalOrder);
    
    // 4. Chuẩn bị dữ liệu cho API in ấn (ĐÃ CẬP NHẬT THEO YÊU CẦU)
    const printData = {
        table: tableName, 
        items: printItemsForPrinter // Gửi MẢNG OBJECT MỚI
    };

    console.log("Dữ liệu in ấn sẽ gửi (API Print):", printData);
    
    let backendSuccess = false;
    let printSuccess = false;

    try {
        // 5. Gửi API backend (Ưu tiên)
        const resp = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(finalOrder)
        });

        const text = await resp.text();
        let bodyStr = text;
        try {
            const j = JSON.parse(text);
            bodyStr = JSON.stringify(j, null, 2);
        } catch (e) {}

        if (resp.ok) {
            console.log("✅ Thành công (API Backend):", bodyStr);
            backendSuccess = true;
        } else {
            console.error(`❌ Lỗi (HTTP ${resp.status}) từ API Backend:\n`, bodyStr);
            showErrorPopup(`❌ Lỗi (HTTP ${resp.status}) từ API Backend:\n` + bodyStr);
        }

        // 6. Nếu API backend thành công, tiến hành gửi lệnh in và Telegram
        if (backendSuccess) {
            // Gửi lệnh in (Dùng printData MỚI)
            try {
                const printResp = await fetch(PRINT_API_ENDPOINT, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(printData)
                });
                
                if (printResp.ok) {
                    console.log("✅ Thành công (API Print).");
                    printSuccess = true;
                } else {
                    console.error(`❌ Lỗi (HTTP ${printResp.status}) từ API Print.`, await printResp.text());
                    // Không show popup lỗi in ấn cho khách, chỉ ghi log console
                }
            } catch (printErr) {
                 console.error("❌ Lỗi kết nối API Print: " + printErr.message, printErr);
                 // Không show popup lỗi in ấn cho khách, chỉ ghi log console
            }
            
            // Gửi Telegram 
            await sendTelegramNotification(message); 
            
            // Hiển thị thành công cuối cùng
            showSuccessPopup(); 
        }

    } catch (err) {
        console.error("❌ Lỗi khi gửi API Backend: " + err.message, err);
        showErrorPopup("❌ Lỗi kết nối API Backend: " + err.message + "\n\nKiểm tra console để biết chi tiết.");
    } finally {
         hideLoading(); // ẨN LOADING
         // Lưu ý: renderCart() được gọi trong closeSuccessPopup() nếu thành công. 
         // Nếu thất bại (backendSuccess=false), cartItems vẫn giữ nguyên, cần gọi lại renderCart để cập nhật trạng thái nút.
         if (!backendSuccess) {
             renderCart();
         }
    }
};

        // --- Khởi chạy Ứng dụng ---
        document.addEventListener('DOMContentLoaded', initData);
    </script>
</body>
</html>
