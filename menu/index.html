<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Nh√† H√†ng Cao C·∫•p - ƒê·∫∑t M√≥n Nhanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /* ƒê·ªãnh nghƒ©a m√†u ch·ªß ƒë·∫°o m·ªõi: Light Wood & Deep Espresso */
        :root {
            --color-primary-wood: #6B4423;      /* N√¢u Espresso ƒê·∫≠m (CTA/Primary - N√∫t b·∫•m) */
            --color-secondary-gold: #A38E6D;    /* ƒê·ªìng M·ªù (Highlight/Price) */
            --color-background-light: #FAF5EF;   /* N·ªÅn t·ªïng th·ªÉ: Kem G·ªó S·ªìi Nh·∫°t */
            --color-card-bg-light: #FFFFFF;     /* N·ªÅn card m√≥n ƒÉn: Tr·∫Øng tinh */
            --color-text-dark: #2C1D15;         /* M√†u ch·ªØ ch√≠nh: N√¢u ƒêen ƒê·∫≠m */
            --color-text-muted: #574B40;        /* M√†u ch·ªØ ph·ª• */
            --color-shadow-wood-light: rgba(107, 68, 35, 0.15); /* Shadow G·ªó Nh·∫π */
            --color-shadow-wood-heavy: rgba(107, 68, 35, 0.3);  /* Shadow G·ªó N·∫∑ng */
            --color-placeholder: #F0E8E1;       /* M√†u trung t√≠nh cho placeholder ·∫£nh */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background-light); 
            color: var(--color-text-dark); 
            -webkit-tap-highlight-color: transparent;
        }
        
        .display-font {
            font-family: 'Playfair Display', serif;
        }

        .stepper-btn {
            transition: transform 0.1s ease-out, background-color 0.1s;
        }
        .stepper-btn:active {
            transform: scale(0.85); 
        }
        .cta-button {
             transition: all 0.15s ease-out;
             box-shadow: 0 4px 10px var(--color-shadow-wood-heavy);
        }
        .cta-button:active {
             transform: scale(0.98);
             box-shadow: 0 2px 5px var(--color-shadow-wood-heavy);
        }

        .ios-card {
            background-color: var(--color-card-bg-light); 
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); 
            box-shadow: 0 4px 12px var(--color-shadow-wood-light);
            border-radius: 24px; 
            will-change: transform, box-shadow;
            border: 1px solid #EBE4D9; 
        }
        .ios-card:hover, .ios-card.active-tap {
            transform: translateY(-4px); 
            box-shadow: 0 8px 18px var(--color-shadow-wood-heavy);
        }
        
        /* --- Style cho Featured Card (ƒê√£ b·ªè, gi·ªØ l·∫°i ph√≤ng tr∆∞·ªùng h·ª£p c·∫ßn thi·∫øt) --- */
        .featured-card {
             background-color: var(--color-card-bg-light); 
             box-shadow: 0 6px 16px var(--color-shadow-wood-heavy);
             border: 2px solid var(--color-secondary-gold);
             transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .featured-card:hover {
            transform: scale(1.02);
        }


        .drawer-bg, .header-bg {
            background-color: var(--color-background-light);
        }
        .cart-drawer {
            transition: transform 0.4s cubic-bezier(0.3, 0.7, 0.4, 1.5);
            transform: translateY(100%);
        }
        .cart-drawer.open {
            transform: translateY(0);
        }
        
        /* --- C·∫≠p nh·∫≠t Style cho Tab Item --- */
        .tab-item {
            position: relative;
            transition: color 0.3s ease-in-out, transform 0.3s ease-in-out;
            font-weight: 700 !important; /* Lu√¥n ƒë·∫≠m */
        }
        .tab-item.active {
             transform: scale(1.05); /* Hi·ªáu ·ª©ng n·ªïi b·∫≠t khi active */
        }
        .tab-item::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px; /* TƒÉng ƒë·ªô d√†y underline */
            background-color: transparent;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scaleX(0);
            border-radius: 2px;
        }
        .tab-item.active::after {
            background-color: var(--color-primary-wood); /* ƒê·ªïi m√†u underline sang Primary Wood */
            transform: scaleX(1);
        }
        
        #floating-cart-bubble {
            box-shadow: 0 6px 15px var(--color-shadow-wood-heavy); 
            border: 2px solid var(--color-card-bg-light); 
        }
        
        @keyframes subtle-shake {
            0%, 100% { transform: scale(1) translate(0, 0); }
            20%, 60% { transform: scale(1.05) translate(-1px, 1px); }
            40%, 80% { transform: scale(1.05) translate(1px, -1px); }
        }
        .bubble-shake {
            animation: subtle-shake 0.4s ease-in-out;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- CSS cho SVG Checkmark Animation --- */
        .checkmark-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checkmark {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: var(--color-primary-wood); 
            stroke-miterlimit: 10;
            box-shadow: inset 0 0 0 var(--color-primary-wood); 
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 4;
            stroke-miterlimit: 10;
            stroke: var(--color-primary-wood);
            fill: none;
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; 
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke: var(--color-primary-wood);
            fill: none;
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; 
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }
        @keyframes fill {
            100% { box-shadow: inset 0 0 0 30px var(--color-background-light); } 
        }

        /* --- CSS cho Loading Spinner ·∫§n T∆∞·ª£ng --- */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        
        .loading-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 60; 
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .loading-message.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .loading-box {
            background-color: var(--color-card-bg-light);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            color: var(--color-text-dark);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .loading-message.show .loading-box {
            transform: scale(1);
        }
        .loading-title {
            color: var(--color-primary-wood);
            font-family: 'Playfair Display', serif;
        }

        /* ------------------------------------- */
        /* --- HI·ªÜU ·ª®NG CHUY·ªÇN TAB M·ªöI (iOS) --- */
        /* ------------------------------------- */
        #menu-list {
            position: relative; /* Quan tr·ªçng cho vi·ªác t·∫°o layer */
            transition: opacity 0.35s ease-in-out, transform 0.35s ease-in-out; 
        }
        
        /* Tr·∫°ng th√°i chu·∫©n b·ªã chuy·ªÉn (·∫©n) */
        #menu-list.fade-out-right {
             opacity: 0;
             transform: translateX(10px); /* B·∫Øt ƒë·∫ßu tr∆∞·ª£t t·ª´ ph·∫£i */
        }
        #menu-list.fade-out-left {
             opacity: 0;
             transform: translateX(-10px); /* B·∫Øt ƒë·∫ßu tr∆∞·ª£t t·ª´ tr√°i */
        }
        
        /* Tr·∫°ng th√°i sau khi chuy·ªÉn (hi·ªán) */
        #menu-list.fade-in {
             opacity: 1;
             transform: translateX(0);
        }
        /* ------------------------------------- */
        
    </style>
</head>
<body>
    <div id="app" class="max-w-xl mx-auto min-h-screen relative p-4 pb-32">
        
        <header class="flex justify-between items-center py-4 sticky top-0 z-30 header-bg">
            <div class="flex items-center space-x-2">
<img 
  src="logobanme.png" 
  alt="Logo Nh√† H√†ng" 
  class="h-20 w-auto rounded-xl shadow-md"
/>


            </div>
            
            <div class="flex-1 text-center absolute left-0 right-0 top-1/2 transform -translate-y-1/2 pointer-events-none">
                <span class="text-4xl font-extrabold tracking-wider display-font" style="color: var(--color-text-dark);">The </span>
                <span class="text-4xl font-extrabold display-font italic" style="color: var(--color-secondary-gold);">Menu</span>
            </div>
            
            <div class="w-[64px] h-16"></div> 
        </header>
        
        <div class="sticky top-20 z-20 pb-4 header-bg">
            <div id="category-tabs" class="flex overflow-x-scroll no-scrollbar space-x-6 pb-2">
                </div>
        </div>

        <div id="menu-list" class="grid grid-cols-2 gap-4 mt-2">
            </div>

        <button id="floating-cart-bubble" 
                class="fixed bottom-6 right-6 z-50 p-4 rounded-full text-white shadow-xl flex items-center space-x-2 transition-all duration-300 scale-0 origin-bottom-right" 
                style="background-color: var(--color-primary-wood);"
                onclick="toggleCart(true)">
            <svg id="cart-svg-bubble" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span id="bubble-item-count" class="font-bold text-sm">0</span>
        </button>

        <div id="fly-clone" class="fixed rounded-full z-50 transition-all duration-500 ease-out pointer-events-none opacity-0" 
             style="background-color: var(--color-primary-wood); width: 0; height: 0;"></div>

        <div id="cart-drawer" class="cart-drawer fixed inset-x-0 bottom-0 z-40 rounded-t-3xl shadow-2xl max-h-[85vh] flex flex-col"
             style="background-color: var(--color-background-light);">
            <div class="p-4 border-b border-gray-100 relative">
                <button onclick="toggleCart(false)" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--color-text-dark);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-xl font-bold text-center" style="color: var(--color-text-dark);">Gi·ªè H√†ng C·ªßa B·∫°n</h2>
            </div>
            
            <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-4">
                <p id="empty-cart-message" class="text-center mt-10" style="color: var(--color-text-muted);">Gi·ªè h√†ng tr·ªëng.</p>
                </div>

            <div id="cart-summary" class="p-4 border-t-2 border-gray-200 shadow-inner" style="background-color: var(--color-card-bg-light);">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold" style="color: var(--color-text-dark);">T·ªïng c·ªông:</span>
                    <span id="cart-total" class="text-2xl font-extrabold" style="color: var(--color-primary-wood);">0ƒë</span>
                </div>
                <button id="checkout-button" class="cta-button w-full text-white font-bold py-3 px-4 rounded-full text-lg shadow-lg opacity-50 cursor-not-allowed" 
                        style="background-color: var(--color-primary-wood);"
                        disabled
                        onclick="handleCheckout()">
                    ƒê·∫∑t m√≥n ngay
                </button>
            </div>
        </div>
        
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="p-8 rounded-xl shadow-2xl w-11/12 max-w-xs transform scale-90 transition-transform duration-300" 
                 style="background-color: var(--color-card-bg-light);">
                <div id="lottie-success-container" class="w-24 h-24 mx-auto mb-4"></div>
                <h3 class="text-xl font-extrabold mb-2 text-center" style="color: var(--color-primary-wood);">ƒê·∫∑t M√≥n Th√†nh C√¥ng!</h3>
                <p class="text-center text-sm" style="color: var(--color-text-muted);">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i.</p>
                <button onclick="closeSuccessPopup()" class="cta-button mt-6 w-full py-3 rounded-full text-white font-semibold" 
                        style="background-color: var(--color-primary-wood);">
                    Ti·∫øp t·ª•c g·ªçi m√≥n
                </button>
            </div>
        </div>

        <div id="error-popup" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="p-8 rounded-xl shadow-2xl w-11/12 max-w-lg transform scale-90 transition-transform duration-300" 
                 style="background-color: var(--color-card-bg-light); border: 2px solid red;">
                <h3 class="text-xl font-extrabold mb-2 text-center text-red-600">L·ªói ƒê·∫∑t M√≥n!</h3>
                <div class="max-h-[60vh] overflow-y-auto p-3 rounded-lg border-2 border-gray-300 mt-3" style="background-color: #f8f8f8;">
                    <pre id="error-message" class="whitespace-pre-wrap text-sm text-red-700"></pre>
                </div>
                <button onclick="closeErrorPopup()" class="cta-button mt-6 w-full py-3 rounded-full text-white font-semibold" 
                        style="background-color: red;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
        
        <div id="loading-overlay" class="loading-message">
            <div class="loading-box">
                 <div class="loading-spinner mx-auto" style="border-top-color: var(--color-primary-wood); border-width: 5px; width: 40px; height: 40px;"></div>
                 <h3 class="text-xl loading-title font-extrabold mt-4">ƒêang G·ª≠i ƒê∆°n H√†ng...</h3>
                 <p class="text-sm mt-1" style="color: var(--color-text-muted);">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.</p>
            </div>
        </div>


    </div>
    
    <script type="module">
        // Import Firebase SDK (D√π kh√¥ng d√πng set, v·∫´n c·∫ßn onValue ƒë·ªÉ t·∫£i menu)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // --- C·∫•u h√¨nh v√† Kh·ªüi t·∫°o Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat-test.appspot.com",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- C·∫•u h√¨nh Telegram ---
        const TELEGRAM_BOT_TOKEN = "7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI";
        const TELEGRAM_CHAT_ID = "-4954039835";
        const API_ENDPOINT = 'https://ordermenu-cp5t2kbgx-thanhduy.vercel.app/api/server.js';


        // --- Bi·∫øn State C·∫ßn Thi·∫øt ---
        let menuData = {};    
        let flatMenuData = {}; 
        let cartItems = {};    
        let categories = {};   
        let activeCategory = '';
        let previousCategory = ''; // *B·ªï sung: Bi·∫øn l∆∞u danh m·ª•c tr∆∞·ªõc ƒë√≥*
        
        // --- D·ªÆ LI·ªÜU M√ìN N·ªîI B·∫¨T (Featured) - ƒê√É B·ªé S·ª¨ D·ª§NG ---
        // const featuredItemIds = ["-O_rTEe0SYGEcdvjBkNk", "-Lw-R-M-aWb-0lI-7H2f"]; 

        // --- Helpers ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('‚Ç´', 'ƒë');
        };

        const getCartTotal = () => {
            return Object.values(cartItems).reduce((sum, item) => sum + item.item.price * item.quantity, 0);
        };
        
        const generateOrderId = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '-';
            for (let i = 0; i < 20; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        };
        
        const generateTableId = () => {
             return '-OaGqKwtZ3S4gzRY14ai';
        };

        const sampleData = {
            drink: {
              "-O_rTJ0wxPOh3vwzVBkf": { name: "pepsi", price: 30000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Pepsi" },
              "-Oa403XF8CuYwOfIK2lh": { name: "Tr√† ƒë√†o cam s·∫£ ƒë·∫∑c bi·ªát", price: 85000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Tra+Dao" }
            },
            food: {
              "-O_rTEe0SYGEcdvjBkNk": { name: "M·∫πc 6 ng∆∞·ªùi", price: 500000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Mec+6" },
              "-Lw-R-M-aWb-0lI-7H2f": { name: "ThƒÉn n·ªôi b√≤ n∆∞·ªõng than", price: 1250000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Bo+Nuong" },
              "-Oa403XF8CuYwOfIK2lh-2": { name: "L·∫©u T·ª© Xuy√™n", price: 450000, img: "https://placehold.co/1000x800/F0E8E1/6B4423?text=Lau+Tu+Xuyen" }
            }
          };

        async function initData() {
            const menuRef = ref(db, "menu");
            onValue(menuRef, (snapshot) => {
                let data = snapshot.val();
                
                if (!data || (Object.keys(data).length === 0)) {
                    console.log("‚ö° Ch∆∞a c√≥ d·ªØ li·ªáu ‚Üí Ghi d·ªØ li·ªáu m·∫´u");
                    data = sampleData;
                    set(menuRef, sampleData)
                        .then(() => console.log("ƒê√£ ghi d·ªØ li·ªáu m·∫´u."))
                        .catch(err => console.error("L·ªói ghi d·ªØ li·ªáu m·∫´u:", err));
                }
                
                loadAndRenderMenu(data);
            }, {
                onlyOnce: false 
            });
        }
        
        function loadAndRenderMenu(data) {
            menuData = {};
            if (data?.food && Object.keys(data.food).length > 0) {
                menuData.foods = data.food;
            }
            if (data?.drink && Object.keys(data.drink).length > 0) {
                menuData.drinks = data.drink;
            }

            categories = {};
            if (menuData.foods) categories.foods = { label: ' M√≥n ƒÇn Ch√≠nh', index: 0 }; /* C·∫≠p nh·∫≠t nh√£n v√† index */
            if (menuData.drinks) categories.drinks = { label: ' Th·ª©c U·ªëng', index: 1 };  /* C·∫≠p nh·∫≠t nh√£n v√† index */
            
            flatMenuData = {};
            let firstCategory = '';
            Object.keys(menuData).forEach(catKey => {
                if (!firstCategory) firstCategory = catKey;
                const items = menuData[catKey];
                Object.keys(items).forEach(id => {
                    flatMenuData[id] = { id: id, ...items[id], categoryKey: catKey, type: catKey === 'foods' ? 'food' : 'drink' }; 
                });
            });
            
            if (!activeCategory || !categories[activeCategory]) {
                 activeCategory = firstCategory || '';
            }

            // renderFeaturedMenu(); // ƒê√£ X√ìA
            renderTabs();
            renderMenu(false); // G·ªçi l·∫ßn ƒë·∫ßu kh√¥ng c·∫ßn animation
            renderCart(); 
        }

        // --- ƒê√É X√ìA: renderFeaturedMenu ---


        // --- Render Functions ---

        // *C·∫≠p nh·∫≠t h√†m renderMenu ƒë·ªÉ h·ªó tr·ª£ animation*
        window.renderMenu = (animate = true) => {
            const menuList = document.getElementById('menu-list');
            if (!menuList) return;

            // 1. N·∫øu c√≥ animation, ·∫©n danh s√°ch m√≥n hi·ªán t·∫°i v·ªõi hi·ªáu ·ª©ng tr∆∞·ª£t
            if (animate) {
                 const currentCatIndex = categories[activeCategory]?.index || 0;
                 const prevCatIndex = categories[previousCategory]?.index || 0;
                 
                 menuList.classList.remove('fade-in');
                 
                 // Quy·∫øt ƒë·ªãnh h∆∞·ªõng tr∆∞·ª£t (Tr√°i: danh m·ª•c m·ªõi c√≥ index nh·ªè h∆°n; Ph·∫£i: danh m·ª•c m·ªõi c√≥ index l·ªõn h∆°n)
                 const directionClass = currentCatIndex > prevCatIndex ? 'fade-out-right' : 'fade-out-left';
                 
                 menuList.classList.add(directionClass);
                 
                 // ƒê·ª£i animation fade out k·∫øt th√∫c (0.35s) r·ªìi render n·ªôi dung m·ªõi
                 setTimeout(() => {
                      updateMenuListContent(menuList);
                      
                      // 3. Hi·ªÉn th·ªã n·ªôi dung m·ªõi v·ªõi hi·ªáu ·ª©ng tr∆∞·ª£t v√†o
                      menuList.classList.remove('fade-out-right', 'fade-out-left');
                      menuList.classList.add('fade-in');

                 }, 350);
            } else {
                 // Kh√¥ng animation, render ngay l·∫≠p t·ª©c
                 updateMenuListContent(menuList);
                 menuList.classList.add('fade-in');
            }
        };

        const updateMenuListContent = (menuList) => {
             menuList.innerHTML = '';
             const items = menuData[activeCategory] || {};
            
            if (Object.keys(items).length === 0) {
                 menuList.innerHTML = `<p class="col-span-2 text-center py-10" style="color: var(--color-text-muted);">Hi·ªán t·∫°i kh√¥ng c√≥ m√≥n n√†o trong danh m·ª•c n√†y.</p>`;
                 return;
            }

            Object.keys(items).forEach(id => {
                const item = flatMenuData[id];
                const imageUrl = item.img && item.img.startsWith('http') 
                                 ? item.img 
                                 : `https://placehold.co/1000x800/F0E8E1/6B4423?text=FOOD+IMAGE`;

                const cardHtml = `
                    <div id="item-${id}" class="ios-card overflow-hidden flex flex-col cursor-pointer" 
                         onclick="addItemToCart('${id}')" 
                         ontouchstart="this.classList.add('active-tap')" ontouchend="this.classList.remove('active-tap')" 
                         onmouseleave="this.classList.remove('active-tap')">
                        <div class="w-full h-[60%] overflow-hidden rounded-t-2xl">
                             <img src="${imageUrl}" 
                                  onerror="this.onerror=null;this.src='https://placehold.co/1000x800/F0E8E1/6B4423?text=FOOD+IMAGE';" 
                                  class="w-full h-full object-cover transition duration-300 transform hover:scale-105" alt="${item.name}">
                        </div>
                        <div class="p-4 flex flex-col justify-between flex-1">
                            <h3 class="text-base font-extrabold line-clamp-2 leading-snug" style="color: var(--color-text-dark);">${item.name}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xl font-bold" style="color: var(--color-secondary-gold);">${formatCurrency(item.price)}</span>
                                <button onclick="event.stopPropagation(); addItemToCart('${id}')" 
                                        class="stepper-btn w-10 h-10 flex items-center justify-center rounded-full text-white shadow-md transition duration-150"
                                        style="background-color: var(--color-primary-wood);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                menuList.innerHTML += cardHtml;
            });
        }


        const renderTabs = () => {
            const tabsContainer = document.getElementById('category-tabs');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = '';
            
            Object.keys(categories).forEach(key => {
                const isActive = key === activeCategory;
                const tabHtml = `
                    <button data-category="${key}" onclick="setActiveCategory('${key}')" 
                            class="tab-item px-1 py-2 text-xl font-extrabold whitespace-nowrap ${isActive ? 'active' : ''}"
                            style="transition: all 0.3s; color: ${isActive ? 'var(--color-primary-wood)' : 'var(--color-text-muted)'};">
                        ${categories[key].label}
                    </button>
                `;
                tabsContainer.innerHTML += tabHtml;
            });
            
            const activeTab = tabsContainer.querySelector(`.tab-item[data-category="${activeCategory}"]`);
            if (activeTab) {
                 activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        };

        // *C·∫≠p nh·∫≠t h√†m setActiveCategory ƒë·ªÉ l∆∞u tr·ªØ danh m·ª•c c≈© v√† g·ªçi renderMenu c√≥ animation*
        window.setActiveCategory = (key) => {
            if (key === activeCategory) return;

            previousCategory = activeCategory; 
            activeCategory = key;
            
            renderTabs();
            renderMenu(true); // K√≠ch ho·∫°t animation
        };

        // window.renderCart 
        window.renderCart = () => {
            try {
                const cartList = document.getElementById('cart-items-list');
                const cartTotalElement = document.getElementById('cart-total');
                const emptyMessage = document.getElementById('empty-cart-message');
                const checkoutButton = document.getElementById('checkout-button');
                
                const floatingBubble = document.getElementById('floating-cart-bubble');
                const bubbleCount = document.getElementById('bubble-item-count');

                if (!cartList) return; 

                cartList.innerHTML = '';
                const total = getCartTotal();
                const itemCount = Object.values(cartItems).reduce((sum, item) => sum + item.quantity, 0);

                if (floatingBubble && bubbleCount) {
                    bubbleCount.textContent = itemCount;
                    floatingBubble.classList.toggle('scale-100', itemCount > 0);
                    floatingBubble.classList.toggle('scale-0', itemCount === 0);
                }
                
                if (cartTotalElement) {
                    cartTotalElement.textContent = formatCurrency(total);
                }

                if (emptyMessage) {
                    emptyMessage.classList.toggle('hidden', itemCount > 0);
                }
                
                if (checkoutButton) {
                    const isSending = checkoutButton.dataset.sending === 'true'; // Ki·ªÉm tra tr·∫°ng th√°i ƒëang g·ª≠i
                    if (itemCount === 0 || isSending) {
                        checkoutButton.disabled = true;
                        checkoutButton.classList.add('opacity-50', 'cursor-not-allowed');
                        if(!isSending) checkoutButton.innerHTML = 'ƒê·∫∑t m√≥n ngay'; // ƒê·∫£m b·∫£o kh√¥ng ghi ƒë√® n·∫øu ƒëang g·ª≠i
                    } else {
                        checkoutButton.disabled = false;
                        checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        checkoutButton.innerHTML = 'ƒê·∫∑t m√≥n ngay';
                    }
                }

                Object.keys(cartItems).forEach(id => {
                    const cartItem = cartItems[id];
                    const item = cartItem.item;
                    
                    const imageUrl = item.img && item.img.startsWith('http') 
                                     ? item.img 
                                     : 'https://placehold.co/100x100/F0E8E1/6B4423?text=FOOD';
                    
                    const itemHtml = `
                        <div class="flex items-center p-3 rounded-xl shadow-sm transition duration-300 border" style="background-color: var(--color-card-bg-light); border-color: #EBE4D9;">
                            <img src="${imageUrl}" 
                                 class="w-16 h-16 object-cover rounded-lg mr-4"
                                 onerror="this.onerror=null;this.src='https://placehold.co/100x100/F0E8E1/6B4423?text=FOOD';">
                            <div class="flex-1 min-w-0">
                                <p class="font-bold truncate text-sm" style="color: var(--color-text-dark);">${item.name}</p>
                                <p class="text-sm font-semibold" style="color: var(--color-secondary-gold);">${formatCurrency(item.price)} x ${cartItem.quantity}</p>
                            </div>
                            <div class="flex items-center space-x-2 border border-gray-200 rounded-full p-1 ml-4 shadow-sm" style="background-color: var(--color-card-bg-light);">
                                <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full bg-white text-gray-500" 
                                        onclick="updateCartQuantity('${id}', -1)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                </button>
                                <span class="font-medium text-sm w-4 text-center" style="color: var(--color-text-dark);">${cartItem.quantity}</span>
                                <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full text-white" 
                                        style="background-color: var(--color-primary-wood);"
                                        onclick="updateCartQuantity('${id}', 1)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartList.innerHTML += itemHtml;
                });
            } catch (error) {
                console.error("L·ªói khi render Cart:", error);
            }
        };

        // --- Cart Actions (Gi·ªØ nguy√™n) ---
        
        window.addItemToCart = (id) => {
            const item = flatMenuData[id];
            
            if (cartItems[id]) {
                cartItems[id].quantity += 1;
            } else {
                cartItems[id] = { item: item, quantity: 1 };
            }

            const floatingBubble = document.getElementById('floating-cart-bubble');
            if (floatingBubble) {
                floatingBubble.classList.add('bubble-shake');
                setTimeout(() => floatingBubble.classList.remove('bubble-shake'), 500);
            }

            const itemCard = document.getElementById(`item-${id}`) || document.querySelector(`.featured-card[onclick*='${id}']`);
            if (itemCard) {
                const startRect = itemCard.getBoundingClientRect();
                const cartIcon = document.getElementById('floating-cart-bubble'); 
                const flyClone = document.getElementById('fly-clone');

                if (cartIcon && flyClone) {
                    const buttonSize = 40; 
                    
                    flyClone.style.top = `${startRect.top + startRect.height / 2 - buttonSize / 2}px`;
                    flyClone.style.left = `${startRect.left + startRect.width / 2 - buttonSize / 2}px`;
                    flyClone.style.width = `${buttonSize}px`;
                    flyClone.style.height = `${buttonSize}px`;
                    flyClone.style.opacity = 1;
                    flyClone.style.transform = 'scale(1)';

                    setTimeout(() => {
                        flyClone.style.top = `${cartIcon.getBoundingClientRect().top + cartIcon.getBoundingClientRect().height / 2 - 10}px`;
                        flyClone.style.left = `${cartIcon.getBoundingClientRect().left + cartIcon.getBoundingClientRect().width / 2 - 10}px`;
                        flyClone.style.width = '20px';
                        flyClone.style.height = '20px';
                        flyClone.style.opacity = 0.5;
                        flyClone.style.transform = 'scale(0.5)';
                    }, 50);

                    setTimeout(() => {
                        flyClone.style.opacity = 0;
                        flyClone.style.transform = 'scale(1)';
                        flyClone.style.width = '0px';
                        flyClone.style.height = '0px';
                        renderCart(); 
                    }, 750);
                } else {
                     renderCart();
                }
            } else {
                 renderCart();
            }
        };
        
        window.updateCartQuantity = (id, change) => {
            if (!cartItems[id]) return;

            const newQuantity = cartItems[id].quantity + change;
            
            if (newQuantity <= 0) {
                delete cartItems[id];
            } else {
                cartItems[id].quantity = newQuantity;
            }
            renderCart();
        };

        window.toggleCart = (open) => {
            const drawer = document.getElementById('cart-drawer');
            if (!drawer) return;

            if (open) {
                if (Object.keys(cartItems).length > 0) {
                    renderCart();
                    drawer.classList.add('open');
                } 
            } else {
                drawer.classList.remove('open');
            }
        };

        // --- Popup Functions (S·ª≠ d·ª•ng SVG/CSS Checkmark) ---
        
        // window.showSuccessPopup 
        window.showSuccessPopup = () => {
             const popup = document.getElementById('success-popup');
             const svgContainer = document.getElementById('lottie-success-container');
             if (!popup || !svgContainer) return;

             // THAY TH·∫æ Lottie b·∫±ng SVG Checkmark v√† animation qua CSS
             svgContainer.innerHTML = `
                 <div class="checkmark-container">
                     <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                         <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                         <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                     </svg>
                 </div>
             `;

             popup.classList.remove('opacity-0', 'pointer-events-none');
             popup.querySelector('div')?.classList.remove('scale-90');
             
             // T·ª± ƒë·ªông ƒë√≥ng sau 3 gi√¢y
             setTimeout(() => {
                closeSuccessPopup();
             }, 3000); 
        };

        // window.closeSuccessPopup 
        window.closeSuccessPopup = () => {
             const popup = document.getElementById('success-popup');
             const svgContainer = document.getElementById('lottie-success-container');
             if (!popup) return;
             popup.classList.add('opacity-0', 'pointer-events-none');
             popup.querySelector('div')?.classList.add('scale-90');
             
             // D·ªçn d·∫πp SVG checkmark
             if (svgContainer) svgContainer.innerHTML = '';

             // Reset gi·ªè h√†ng sau khi ƒë·∫∑t m√≥n th√†nh c√¥ng
             cartItems = {};
             renderCart();
        };

        // window.showErrorPopup 
        window.showErrorPopup = (message) => {
            const popup = document.getElementById('error-popup');
            const errorMessage = document.getElementById('error-message');
            if (!popup || !errorMessage) return;

            errorMessage.textContent = message;
            popup.classList.remove('opacity-0', 'pointer-events-none');
            popup.querySelector('div')?.classList.remove('scale-90');
        };

        // window.closeErrorPopup 
        window.closeErrorPopup = () => {
            const popup = document.getElementById('error-popup');
            if (!popup) return;
            popup.classList.add('opacity-0', 'pointer-events-none');
            popup.querySelector('div')?.classList.add('scale-90');
        };

        // --- Loading Overlay Functions M·ªöI ---
        const showLoading = () => {
             document.getElementById('loading-overlay')?.classList.add('show');
             document.getElementById('checkout-button')?.setAttribute('data-sending', 'true');
             document.getElementById('checkout-button').innerHTML = '<span class="loading-spinner"></span> ƒêang g·ª≠i...';
        };

        const hideLoading = () => {
             document.getElementById('loading-overlay')?.classList.remove('show');
             document.getElementById('checkout-button')?.removeAttribute('data-sending');
        };


        // --- Telegram & Checkout Logic (C·∫≠p nh·∫≠t) ---

        async function sendTelegramNotification(message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const params = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (!response.ok) {
                    console.error("L·ªói Telegram API:", await response.text());
                } else {
                    console.log("Th√¥ng b√°o Telegram ƒë√£ g·ª≠i th√†nh c√¥ng.");
                }
            } catch (err) {
                console.error("L·ªói k·∫øt n·ªëi Telegram:", err);
            }
        }
        
        window.handleCheckout = async () => {
            
            toggleCart(false);

            if (Object.keys(cartItems).length === 0) {
                 showErrorPopup("Gi·ªè h√†ng tr·ªëng. Vui l√≤ng ch·ªçn m√≥n tr∆∞·ªõc khi ƒë·∫∑t.");
                 return;
            }
            
            showLoading(); // HI·ªÇN TH·ªä LOADING

            const tableName = "B1"; 
            const totalAmount = getCartTotal(); // L·∫•y t·ªïng ti·ªÅn

            const itemsObject = {};
            let foodItems = [];
            let drinkItems = [];
            let hasFood = false;
            let hasDrink = false;

            // 1. Ph√¢n lo·∫°i v√† ƒë·ªãnh d·∫°ng m√≥n ƒÉn/th·ª©c u·ªëng cho Telegram
            Object.keys(cartItems).forEach(id => {
                const ci = cartItems[id];
                const itemType = ci.item.type;
                
                // ƒê·ªãnh d·∫°ng cho tin nh·∫Øn Telegram (d√πng Markdown: *bold*)
                const itemString = `- ${ci.item.name} x *${ci.quantity}* (${formatCurrency(ci.item.price)})`;

                if (itemType === 'food') {
                    hasFood = true;
                    foodItems.push(itemString);
                } else if (itemType === 'drink') {
                    hasDrink = true;
                    drinkItems.push(itemString);
                }
                
                itemsObject[id] = { 
                    itemName: ci.item.name,
                    price: ci.item.price,
                    quantity: ci.quantity,
                    status: "pending", 
                    type: itemType 
                };
            });
            
            // 2. X√¢y d·ª±ng n·ªôi dung tin nh·∫Øn Telegram
            let message = `*üßæ ƒê∆†N H√ÄNG M·ªöI (B√†n ${tableName})* \n`;
            message += `--------------------------------------\n`;

            if (hasFood) {
                message += `\n*üçΩÔ∏è B·∫æP (M√ìN ƒÇN)*\n`;
                message += foodItems.join('\n');
                message += `\n`;
            }

            if (hasDrink) {
                message += `\n*üçπ BAR (TH·ª®C U·ªêNG)*\n`;
                message += drinkItems.join('\n');
                message += `\n`;
            }

            message += `\n*üíµ T·ªîNG C·ªòNG: ${formatCurrency(totalAmount)}*`;
            
            // 3. Chu·∫©n b·ªã Order cho API backend
            let orderType = 'misc'; 
            if (hasFood && hasDrink) {
                orderType = 'food_and_drink';
            } else if (hasFood) {
                orderType = 'food';
            } else if (hasDrink) {
                orderType = 'drink';
            }

            const finalOrder = {
                orderId: generateOrderId(), 
                tableId: generateTableId(), 
                tableName: tableName, 
                type: orderType, 
                items: itemsObject
            };
            
            console.log("JSON ƒê·∫∑t M√≥n S·∫Ω G·ª≠i:", finalOrder);
            
            
            try {
                // G·ª≠i API backend
                const resp = await fetch(API_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(finalOrder)
                });

                const text = await resp.text();
                let bodyStr = text;
                try {
                    const j = JSON.parse(text);
                    bodyStr = JSON.stringify(j, null, 2);
                } catch (e) {}

                if (resp.ok) {
                    console.log("‚úÖ Th√†nh c√¥ng:", bodyStr);
                    // G·ª≠i Telegram sau khi API backend th√†nh c√¥ng
                    await sendTelegramNotification(message); 
                    showSuccessPopup(); 
                } else {
                    console.error(`‚ùå L·ªói (HTTP ${resp.status}):\n`, bodyStr);
                    showErrorPopup(`‚ùå L·ªói (HTTP ${resp.status}):\n` + bodyStr);
                }
            } catch (err) {
                console.error("‚ùå L·ªói khi g·ª≠i: " + err.message, err);
                showErrorPopup("‚ùå L·ªói k·∫øt n·ªëi API: " + err.message + "\n\nKi·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.");
            } finally {
                 hideLoading(); // ·∫®N LOADING
                 renderCart(); 
            }
        };


        // --- Kh·ªüi ch·∫°y ·ª®ng d·ª•ng ---
        document.addEventListener('DOMContentLoaded', initData);
    </script>
</body>
</html>
