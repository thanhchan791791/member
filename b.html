<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Chi Ti√™u</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --info-color: #1abc9c;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        .container-fluid {
            padding: 20px;
        }

        .navbar {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            background-color: #fff;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            border: none;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stats-card .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
        }

        .bg-income { background-color: var(--success-color); }
        .bg-expense { background-color: var(--danger-color); }
        .bg-balance { background-color: var(--primary-color); }
        .bg-report { background-color: var(--info-color); }

        .chart-container {
            height: 350px;
            width: 100%;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1), transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .transaction-item:hover {
            background-color: #f7f7f7;
            transform: scale(1.01);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 18px;
            margin-right: 15px;
        }
        
        .transaction-item .amount {
            font-weight: bold;
            font-size: 1.1em;
            margin-left: auto;
        }

        .main-action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .main-action-buttons .btn-circle {
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 22px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-action-buttons .btn-circle:active {
            transform: scale(0.9);
        }

        .modal.fade .modal-dialog {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform: translateY(50px);
        }

        .modal.fade.show .modal-dialog {
            transform: none;
        }
        
        .transaction-date-header {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
            margin-bottom: 5px;
            padding-left: 15px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="#">üí∞ Qu·∫£n L√Ω Chi Ti√™u</a>
            <span id="userIdDisplay" class="text-muted fw-bold">ID ng∆∞·ªùi d√πng: ƒêang t·∫£i...</span>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row g-4">
            <div class="col-lg-12">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card p-4 stats-card">
                            <div>
                                <h6 class="text-muted">T·ªïng thu nh·∫≠p</h6>
                                <h4 class="fw-bold text-success" id="totalIncome">0‚Ç´</h4>
                                <button class="btn btn-sm btn-outline-success mt-2" data-bs-toggle="modal" data-bs-target="#updateIncomeModal">C·∫≠p nh·∫≠t</button>
                            </div>
                            <div class="icon-circle bg-income">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 stats-card">
                            <div>
                                <h6 class="text-muted">T·ªïng chi ti√™u</h6>
                                <h4 class="fw-bold text-danger" id="totalExpense">0‚Ç´</h4>
                                <button class="btn btn-sm btn-outline-danger mt-2" data-bs-toggle="modal" data-bs-target="#statisticsModal">Xem Th·ªëng K√™</button>
                            </div>
                            <div class="icon-circle bg-expense">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 stats-card">
                            <div>
                                <h6 class="text-muted">S·ªë d∆∞ c√≤n l·∫°i</h6>
                                <h4 class="fw-bold text-primary" id="netBalance">0‚Ç´</h4>
                            </div>
                            <div class="icon-circle bg-balance">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="card p-4 mt-4">
                    <h5 class="mb-3">L·ªãch s·ª≠ giao d·ªãch</h5>
                    <div class="list-group list-group-flush" id="transactionList">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-action-buttons">
        <button class="btn btn-primary btn-circle" data-bs-toggle="modal" data-bs-target="#addTransactionModal"><i class="fas fa-plus"></i></button>
    </div>
    
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel">Th√™m Giao D·ªãch M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label for="transactionType" class="form-label">Lo·∫°i giao d·ªãch</label>
                            <select class="form-select" id="transactionType">
                                <option value="expense">Chi ti√™u</option>
                                <option value="income">Thu nh·∫≠p</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transactionAmount" class="form-label">S·ªë ti·ªÅn</label>
                            <input type="text" class="form-control" id="transactionAmount" required inputmode="numeric">
                        </div>
                        <div class="mb-3">
                            <label for="transactionDescription" class="form-label">M√¥ t·∫£</label>
                            <input type="text" class="form-control" id="transactionDescription" placeholder="V√≠ d·ª•: Mua b√†n gh·∫ø" required>
                        </div>
                        <div class="mb-3">
                            <label for="transactionDate" class="form-label">Ng√†y</label>
                            <input type="date" class="form-control" id="transactionDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" form="transactionForm" class="btn btn-primary">L∆∞u giao d·ªãch</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updateIncomeModal" tabindex="-1" aria-labelledby="updateIncomeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateIncomeModalLabel">C·∫≠p nh·∫≠t S·ªë d∆∞ ban ƒë·∫ßu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateIncomeForm">
                        <div class="mb-3">
                            <label for="newIncomeAmount" class="form-label">Nh·∫≠p s·ªë d∆∞ m·ªõi</label>
                            <input type="text" class="form-control" id="newIncomeAmount" required inputmode="numeric">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" form="updateIncomeForm" class="btn btn-primary">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th·ªëng K√™ -->
    <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statisticsModalLabel">Th·ªëng K√™ Chi Ti√™u</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label">T·ª´ ng√†y</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label">ƒê·∫øn ng√†y</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    <div class="d-grid mb-4">
                        <button class="btn btn-primary" id="applyDateFilter">√Åp d·ª•ng</button>
                    </div>

                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <div class="card p-3 bg-income text-white">
                                <h6 class="mb-0">T·ªïng thu nh·∫≠p</h6>
                                <h4 class="fw-bold" id="statsIncome">0‚Ç´</h4>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-3 bg-expense text-white">
                                <h6 class="mb-0">T·ªïng chi ti√™u</h6>
                                <h4 class="fw-bold" id="statsExpense">0‚Ç´</h4>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-3 bg-balance text-white">
                                <h6 class="mb-0">S·ªë d∆∞</h6>
                                <h4 class="fw-bold" id="statsBalance">0‚Ç´</h4>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-pills mb-3" id="stats-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stats-daily-tab" data-bs-toggle="pill" data-bs-target="#stats-daily" type="button" role="tab" aria-controls="stats-daily" aria-selected="true">Ng√†y</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-weekly-tab" data-bs-toggle="pill" data-bs-target="#stats-weekly" type="button" role="tab" aria-controls="stats-weekly" aria-selected="false">Tu·∫ßn</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-monthly-tab" data-bs-toggle="pill" data-bs-target="#stats-monthly" type="button" role="tab" aria-controls="stats-monthly" aria-selected="false">Th√°ng</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="stats-tabContent">
                        <div class="tab-pane fade show active" id="stats-daily" role="tabpanel" aria-labelledby="stats-daily-tab">
                            <div class="chart-container">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="stats-weekly" role="tabpanel" aria-labelledby="stats-weekly-tab">
                            <div class="chart-container">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="stats-monthly" role="tabpanel" aria-labelledby="stats-monthly-tab">
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, push, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id.replace(/\./g, '-') : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let totalIncome = 0;
        let totalExpense = 0;
        let transactions = [];
        let initialBalance = 0;
        const todayFormatted = new Date().toISOString().split('T')[0];

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);

                // Attempt to sign in with custom token, if it exists
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (e) {
                        console.error("L·ªói khi ƒëƒÉng nh·∫≠p b·∫±ng token t√πy ch·ªânh, chuy·ªÉn sang ƒëƒÉng nh·∫≠p ·∫©n danh:", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').innerText = ``;
                        setupRealtimeListeners();
                    } else {
                        console.log("Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng xu·∫•t.");
                    }
                });
            } catch (error) {
                console.error("L·ªói khi kh·ªüi t·∫°o Firebase ho·∫∑c x√°c th·ª±c:", error);
            }
        };

        const setupRealtimeListeners = () => {
            // Listen for transactions
            const transactionsRef = ref(db, `artifacts/${appId}/public/data/transactions`);
            onValue(transactionsRef, (snapshot) => {
                const fetchedTransactions = [];
                snapshot.forEach((childSnapshot) => {
                    const transactionData = childSnapshot.val();
                    fetchedTransactions.push({ id: childSnapshot.key, ...transactionData });
                });
                transactions = fetchedTransactions;
                recalculateAndRender();
            }, (error) => {
                console.error("L·ªói khi l·∫Øng nghe Firebase Realtime Database transactions:", error);
            });

            // Listen for initial balance
            const balanceRef = ref(db, `artifacts/${appId}/public/data/initialBalance`);
            onValue(balanceRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    initialBalance = data.amount || 0;
                } else {
                    initialBalance = 0;
                }
                recalculateAndRender();
            }, (error) => {
                console.error("L·ªói khi l·∫Øng nghe Firebase Realtime Database balance:", error);
            });
        };

        const recalculateAndRender = () => {
            totalIncome = initialBalance;
            totalExpense = 0;
            
            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            updateSummary();
            renderTransactions();
        };

        const formatCurrency = (amount) => {
            return amount.toLocaleString('vi-VN') + '‚Ç´';
        };

        const updateSummary = () => {
            const balance = totalIncome - totalExpense;
            document.getElementById('totalIncome').innerText = formatCurrency(totalIncome);
            document.getElementById('totalExpense').innerText = formatCurrency(totalExpense);
            const balanceElement = document.getElementById('netBalance');
            balanceElement.innerText = formatCurrency(balance);
            balanceElement.className = `fw-bold ${balance >= 0 ? 'text-primary' : 'text-danger'}`;
        };

        const createTransactionItem = (type, amount, description, itemUserId) => {
            const iconClass = type === 'income' ? 'bg-success' : 'bg-danger';
            const iconSymbol = type === 'income' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
            const amountClass = type === 'expense' ? 'text-danger' : 'text-success';
            const sign = type === 'expense' ? '-' : '+';
            const formattedAmount = formatCurrency(amount);
            const isCurrentUser = itemUserId === userId;
            const userLabel = isCurrentUser ? 'B·∫°n' : `Ng∆∞·ªùi d√πng: ${itemUserId.substring(0, 8)}`;

            const newItem = document.createElement('div');
            newItem.className = 'transaction-item';
            newItem.innerHTML = `
                <div class="icon ${iconClass}"><i class="${iconSymbol}"></i></div>
                <div class="details">
                    <h6 class="mb-0">${description}</h6>
                    <small class="text-muted">${userLabel}</small>
                </div>
                <span class="amount ${amountClass}">${sign}${formattedAmount}</span>
            `;
            return newItem;
        };

        const renderTransactions = () => {
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const groupedTransactions = transactions.reduce((groups, transaction) => {
                const date = transaction.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(transaction);
                return groups;
            }, {});

            const sortedDates = Object.keys(groupedTransactions).sort((a, b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                const noTransactionsMsg = document.createElement('div');
                noTransactionsMsg.className = 'text-center text-muted py-5';
                noTransactionsMsg.innerText = 'Ch∆∞a c√≥ giao d·ªãch n√†o.';
                transactionList.appendChild(noTransactionsMsg);
            } else {
                sortedDates.forEach(date => {
                    const header = document.createElement('h6');
                    header.className = 'transaction-date-header';
                    const displayDate = date === todayFormatted ? 'H√¥m nay' : date.split('-').reverse().join('/');
                    header.innerText = displayDate;
                    transactionList.appendChild(header);

                    groupedTransactions[date].forEach(t => {
                        const item = createTransactionItem(t.type, t.amount, t.description, t.userId);
                        transactionList.appendChild(item);
                    });
                });
            }
        };

        const formatNumberInput = (event) => {
            let input = event.target;
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        let dailyChart, weeklyChart, monthlyChart;

        const createChart = (id, options) => {
            const ctx = document.getElementById(id).getContext('2d');
            const data = {
                labels: [],
                datasets: [
                    { label: 'Chi ti√™u', data: [], backgroundColor: 'rgba(231, 76, 60, 0.7)', borderColor: 'rgba(231, 76, 60, 1)', borderWidth: 1, fill: false },
                    { label: 'Thu nh·∫≠p', data: [], backgroundColor: 'rgba(46, 204, 113, 0.7)', borderColor: 'rgba(46, 204, 113, 1)', borderWidth: 1, fill: false }
                ]
            };
            return new Chart(ctx, { type: 'line', data: data, options: options });
        };
        
        const updateCharts = (filteredTransactions) => {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'S·ªë ti·ªÅn (VND)' },
                        ticks: { callback: (value) => formatCurrency(value) }
                    },
                    x: { title: { display: true, text: 'Th·ªùi gian' } }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                label += formatCurrency(context.parsed.y);
                                return label;
                            }
                        }
                    }
                }
            };
            
            // Daily chart
            const dailyDataMap = filteredTransactions.reduce((acc, t) => {
                const date = t.date;
                if (!acc[date]) { acc[date] = { income: 0, expense: 0 }; }
                if (t.type === 'income') { acc[date].income += t.amount; } else { acc[date].expense += t.amount; }
                return acc;
            }, {});
            const dailyLabels = Object.keys(dailyDataMap).sort().map(date => date.split('-').reverse().join('/'));
            const dailyExpenses = Object.keys(dailyDataMap).sort().map(date => dailyDataMap[date].expense);
            const dailyIncomes = Object.keys(dailyDataMap).sort().map(date => dailyDataMap[date].income);
            
            if (dailyChart) dailyChart.destroy();
            dailyChart = createChart('dailyChart', chartOptions);
            dailyChart.data.labels = dailyLabels;
            dailyChart.data.datasets[0].data = dailyExpenses;
            dailyChart.data.datasets[1].data = dailyIncomes;
            dailyChart.update();

            // Weekly chart
            const weeklyDataMap = {};
            filteredTransactions.forEach(t => {
                const date = new Date(t.date);
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDays = (date - firstDayOfYear) / 86400000;
                const week = Math.ceil((pastDays + firstDayOfYear.getDay() + 1) / 7);
                const weekKey = `${date.getFullYear()}-W${week}`;
                if (!weeklyDataMap[weekKey]) { weeklyDataMap[weekKey] = { income: 0, expense: 0 }; }
                if (t.type === 'income') { weeklyDataMap[weekKey].income += t.amount; } else { weeklyDataMap[weekKey].expense += t.amount; }
            });
            const weeklyLabels = Object.keys(weeklyDataMap).sort().map(key => `Tu·∫ßn ${key.split('-W')[1]}`);
            const weeklyExpenses = Object.keys(weeklyDataMap).sort().map(key => weeklyDataMap[key].expense);
            const weeklyIncomes = Object.keys(weeklyDataMap).sort().map(key => weeklyDataMap[key].income);

            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = createChart('weeklyChart', chartOptions);
            weeklyChart.data.labels = weeklyLabels;
            weeklyChart.data.datasets[0].data = weeklyExpenses;
            weeklyChart.data.datasets[1].data = weeklyIncomes;
            weeklyChart.update();

            // Monthly chart
            const monthlyDataMap = {};
            filteredTransactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                if (!monthlyDataMap[monthKey]) { monthlyDataMap[monthKey] = { income: 0, expense: 0 }; }
                if (t.type === 'income') { monthlyDataMap[monthKey].income += t.amount; } else { monthlyDataMap[monthKey].expense += t.amount; }
            });
            const monthlyLabels = Object.keys(monthlyDataMap).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            }).map(key => `Th√°ng ${key.split('-')[1]}`);
            const monthlyExpenses = Object.keys(monthlyDataMap).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            }).map(key => monthlyDataMap[key].expense);
            const monthlyIncomes = Object.keys(monthlyDataMap).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            }).map(key => monthlyDataMap[key].income);

            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = createChart('monthlyChart', chartOptions);
            monthlyChart.data.labels = monthlyLabels;
            monthlyChart.data.datasets[0].data = monthlyExpenses;
            monthlyChart.data.datasets[1].data = monthlyIncomes;
            monthlyChart.update();
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('transactionDate').value = todayFormatted;

            document.getElementById('transactionAmount').addEventListener('input', formatNumberInput);
            document.getElementById('newIncomeAmount').addEventListener('input', formatNumberInput);

            document.getElementById('transactionForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const type = document.getElementById('transactionType').value;
                const amount = parseInt(document.getElementById('transactionAmount').value.replace(/\./g, ''));
                const description = document.getElementById('transactionDescription').value;
                const date = document.getElementById('transactionDate').value;

                try {
                    const transactionsRef = ref(db, `artifacts/${appId}/public/data/transactions`);
                    await push(transactionsRef, {
                        userId: userId,
                        type: type,
                        amount: amount,
                        description: description,
                        date: date,
                        timestamp: new Date().toISOString()
                    });
                    bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
                    this.reset();
                    document.getElementById('transactionDate').value = todayFormatted;
                } catch (e) {
                    console.error("L·ªói khi th√™m giao d·ªãch: ", e);
                }
            });

            document.getElementById('updateIncomeForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const newAmount = parseInt(document.getElementById('newIncomeAmount').value.replace(/\./g, ''));
                
                try {
                    const balanceRef = ref(db, `artifacts/${appId}/public/data/initialBalance`);
                    await set(balanceRef, {
                        userId: userId,
                        amount: newAmount,
                        timestamp: new Date().toISOString()
                    });
                    bootstrap.Modal.getInstance(document.getElementById('updateIncomeModal')).hide();
                    this.reset();
                } catch (e) {
                    console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë d∆∞ ban ƒë·∫ßu: ", e);
                }
            });

            const updateStats = (filteredTransactions) => {
                const statsIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const statsExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const statsBalance = statsIncome - statsExpense;
                
                document.getElementById('statsIncome').innerText = formatCurrency(statsIncome);
                document.getElementById('statsExpense').innerText = formatCurrency(statsExpense);
                document.getElementById('statsBalance').innerText = formatCurrency(statsBalance);

                updateCharts(filteredTransactions);
            };

            const filterTransactionsByDate = (start, end) => {
                const startDate = start ? new Date(start) : null;
                const endDate = end ? new Date(end) : null;
                
                return transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const isAfterStart = !startDate || transactionDate >= startDate;
                    const isBeforeEnd = !endDate || transactionDate <= endDate;
                    return isAfterStart && isBeforeEnd;
                });
            };

            document.getElementById('applyDateFilter').addEventListener('click', () => {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const filtered = filterTransactionsByDate(startDate, endDate);
                updateStats(filtered);
            });

            const statisticsModal = document.getElementById('statisticsModal');
            statisticsModal.addEventListener('show.bs.modal', () => {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                updateStats(transactions);
            });

            initFirebase();
        });
    </script>
</body>
</html>
