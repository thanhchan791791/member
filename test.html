<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu In Ấn Bếp (Mobile Ready)</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Style cho pop-up */
        .popup-modal {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        .popup-modal.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6">
    
    <!-- Header -->
    <header class="w-full max-w-lg mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Hệ Thống Đặt Món Bếp</h1>
        <p class="text-sm text-gray-500">Gửi lệnh in trực tiếp tới máy chủ cục bộ.</p>
        <div class="mt-4 p-2 bg-yellow-100 border border-yellow-300 rounded-lg text-xs text-left">
            <p class="font-semibold">Cấu hình API:</p>
            <code class="block overflow-auto break-all">http://192.168.156.102:5000/print</code>
            <p class="mt-1">✅ Đã kiểm tra CORS. Hoạt động trên GitHub Pages/Vercel.</p>
        </div>
    </header>

    <!-- Form Đặt Món -->
    <main class="w-full max-w-lg bg-white p-6 rounded-xl shadow-2xl">
        <div class="mb-6">
            <label for="table-input" class="block text-sm font-medium text-gray-700 mb-1">Tên Bàn/Phòng</label>
            <input type="text" id="table-input" value="Bàn 08" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                   placeholder="Nhập tên bàn (ví dụ: Bàn 08)">
        </div>

        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Danh Sách Món Ăn Mặc Định</h2>
            <div id="item-list" class="space-y-3">
                <!-- Các món ăn được tạo động bằng JS -->
            </div>
        </div>

        <!-- Nút Gửi Lệnh In -->
        <button id="send-print-btn" 
                class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50">
            Gửi Lệnh In (BP-T3)
        </button>

        <p id="result-message" class="mt-4 text-center text-sm font-medium"></p>
    </main>

    <!-- Modal Thông báo -->
    <div id="popup-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 popup-modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-11/12 text-center">
            <h3 id="popup-title" class="text-xl font-bold mb-3">Thông báo</h3>
            <p id="popup-content" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('popup-container').classList.remove('show')" 
                    class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                Đã hiểu
            </button>
        </div>
    </div>

    <script>
        // Cấu hình API và Máy in
        const PRINT_API_URL = "http://192.168.156.102:5000/print";
        const PRINTER_NAME = "BP-T3";
        
        // Dữ liệu món ăn mẫu (Mô phỏng đơn hàng curl)
        const DEFAULT_ITEMS = [
            { name: "Mẹt 5 người", quantity: 1, note: "" },
            { name: "Canh cà đắng", quantity: 1, note: "" },
            { name: "Gà nướng cơm lam", quantity: 2, note: "" },
            { name: "Canh khổ qua", quantity: 1, note: "" },
            { name: "Pepsi", quantity: 4, note: "Uong kem da" }
        ];

        // --- DOM Elements ---
        const itemListDiv = document.getElementById('item-list');
        const tableInput = document.getElementById('table-input');
        const sendBtn = document.getElementById('send-print-btn');
        const resultMsg = document.getElementById('result-message');
        const popupContainer = document.getElementById('popup-container');
        const popupTitle = document.getElementById('popup-title');
        const popupContent = document.getElementById('popup-content');

        // --- UTILITY FUNCTIONS ---
        function showPopup(title, content, isError = false) {
            popupTitle.textContent = title;
            popupContent.innerHTML = content.replace(/\n/g, '<br>'); // Hỗ trợ xuống dòng
            popupTitle.className = `text-xl font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
            popupContainer.classList.add('show');
        }

        function toggleLoading(isLoading) {
            sendBtn.disabled = isLoading;
            sendBtn.textContent = isLoading ? 'Đang gửi lệnh...' : 'Gửi Lệnh In (BP-T3)';
            resultMsg.textContent = '';
            if (isLoading) {
                resultMsg.classList.remove('text-red-500', 'text-green-500');
                resultMsg.textContent = 'Đang chờ phản hồi từ máy chủ in...';
            }
        }

        // --- RENDER & INIT ---
        function renderItems() {
            itemListDiv.innerHTML = '';
            DEFAULT_ITEMS.forEach((item, index) => {
                const itemHtml = `
                    <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center border border-gray-200">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${index + 1}. ${item.name}</p>
                            <p class="text-sm text-gray-500">SL: ${item.quantity}</p>
                            ${item.note ? `<p class="text-xs text-indigo-500 mt-1">Ghi chú: ${item.note}</p>` : ''}
                        </div>
                    </div>
                `;
                itemListDiv.innerHTML += itemHtml;
            });
        }

        // --- CORE LOGIC: SEND PRINT REQUEST ---
        async function sendPrintRequest() {
            const table = tableInput.value || "Bàn Test";

            // Tạo payload JSON theo cấu trúc bạn đã cung cấp
            const payload = {
                "printer": PRINTER_NAME,
                "order": {
                    "table": table,
                    "items": DEFAULT_ITEMS
                }
            };

            toggleLoading(true);
            console.log("➡️ Đang gửi Yêu cầu In tới:", PRINT_API_URL);
            console.log("➡️ Payload:", JSON.stringify(payload, null, 2));

            try {
                const resp = await fetch(PRINT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(payload)
                });

                // Lấy nội dung phản hồi (có thể là JSON hoặc text)
                const text = await resp.text();
                let bodyData;
                try {
                    bodyData = JSON.parse(text);
                } catch (e) {
                    bodyData = { message: "Phản hồi không phải JSON: " + text.substring(0, 100) };
                }

                if (resp.ok) {
                    // Thành công: Mã 200-299
                    console.log("✅ API Print Server Phản hồi Thành công:", bodyData);
                    const msg = `✅ Lệnh in đã được gửi thành công!\n\nMáy in: ${bodyData.printer || PRINTER_NAME}\n\nXem trước:\n${bodyData.preview_content || 'Không có xem trước.'}`;
                    showPopup("In Thành Công", msg);
                    resultMsg.textContent = 'In thành công! Kiểm tra máy in.';
                    resultMsg.className = 'mt-4 text-center text-sm font-medium text-green-600';
                } else {
                    // Lỗi: Mã 4xx, 5xx
                    console.error(`❌ API Print Server Lỗi (HTTP ${resp.status}):`, bodyData);
                    const errorMsg = `❌ Lỗi máy chủ in (${resp.status}):\n\n${bodyData.message || bodyData.status || 'Lỗi không xác định.'}\n\nKiểm tra Tường lửa và Console.`;
                    showPopup("Lỗi In Ấn", errorMsg, true);
                    resultMsg.textContent = `Lỗi (${resp.status}). Kiểm tra chi tiết.`;
                    resultMsg.className = 'mt-4 text-center text-sm font-medium text-red-600';
                }
            } catch (error) {
                // Lỗi kết nối mạng (Tường lửa, IP sai, Server tắt)
                console.error("❌ Lỗi KẾT NỐI MẠNG/FIREWALL:", error);
                const networkErrorMsg = `❌ Lỗi kết nối mạng/tường lửa:\n\nKhông thể kết nối tới ${PRINT_API_URL}.\n\nKiểm tra:\n1. Tường lửa (mở cổng 5000).\n2. Cùng mạng Wi-Fi (LAN).`;
                showPopup("Lỗi Kết Nối", networkErrorMsg, true);
                resultMsg.textContent = 'Lỗi kết nối. Kiểm tra console.';
                resultMsg.className = 'mt-4 text-center text-sm font-medium text-red-600';
            } finally {
                toggleLoading(false);
            }
        }

        // --- Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            renderItems();
            sendBtn.addEventListener('click', sendPrintRequest);
        });

    </script>
</body>
</html>
